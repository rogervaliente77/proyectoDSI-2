<div class="container-fluid bg-light min-vh-100 py-5">

  <!-- Cabecera -->
  <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between mb-4 p-4 rounded" style="background-color: #cfe2ff; gap: 1.5rem;">
    <div class="d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; border-radius: 50%; background-color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.15); overflow: hidden;">
      <img src="https://i.ibb.co/B2QsNGLm/20250913-1732-Logo-Herramientas-Ferre-Pro-remix-01k52pmwf5ewavwk0cjb9g6k1z-1.png" alt="Logo" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain;">
    </div>

    <div class="text-center flex-grow-1">
      <h1 class="h3 text-dark fw-bold mb-1">Catálogo de Productos</h1>
      <p class="text-muted mb-0 small">Descubre nuestras mejores opciones e inicia sesión o crea una cuenta para comprar.</p>
    </div>

    <div class="d-flex gap-2 flex-wrap mt-3 mt-lg-0">
      <%= link_to portal_login_path, class: "btn btn-primary btn-sm shadow-sm" do %>
        <i class="fas fa-sign-in-alt me-1"></i> Iniciar Sesión
      <% end %>
      <%= link_to portal_signup_path, class: "btn btn-outline-primary btn-sm shadow-sm" do %>
        <i class="fas fa-user-plus me-1"></i> Crear Cuenta
      <% end %>
    </div>
  </div>

  <!-- Filtros -->
  <div class="position-sticky top-0 bg-light shadow-sm py-3 mb-3" style="z-index: 1050;">
    <div class="container">
      <%= form_with url: landing_index_path, method: :get, local: true, class: "row row-cols-lg-auto g-2 align-items-end justify-content-start" do %>
        <div class="col">
          <label class="form-label small text-secondary">Buscar</label>
          <%= text_field_tag :query, params[:query], placeholder: "Ej. Taladro, Laptop...", class: "form-control form-control-sm" %>
        </div>
        <div class="col">
          <label class="form-label small text-secondary">Categoría</label>
          <%= select_tag :category_id, options_from_collection_for_select(@categories, :id, :name, params[:category_id]), prompt: "Todas", class: "form-select form-select-sm" %>
        </div>
        <div class="col">
          <label class="form-label small text-secondary">Marca</label>
          <%= select_tag :marca_id, options_from_collection_for_select(@marcas, :id, :name, params[:marca_id]), prompt: "Todas", class: "form-select form-select-sm" %>
        </div>
        <div class="col">
          <label class="form-label small text-secondary">Oferta</label>
          <%= select_tag :offer, options_for_select([["Descuento", "descuento"], ["2x1", "2x1"], ["3x1", "3x1"], ["Mayoreo", "mayoreo"]], params[:offer]), include_blank: "Seleccione...", class: "form-select form-select-sm" %>
        </div>
        <div class="col d-flex align-items-end gap-2">
          <%= submit_tag "Aplicar", class: "btn btn-primary btn-sm" %>
          <%= link_to "Reiniciar", landing_index_path, class: "btn btn-outline-secondary btn-sm" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Productos -->
  <div class="row g-3">
    <% if @products.any? %>
      <% @products.each do |product| %>
        <% images = product.product_images.map(&:image_url) %>
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
          <div class="card border-0 shadow-sm rounded-lg h-100 product-card bg-white position-relative" style="overflow: visible;">
            
            <!-- Badges de oferta y disponibilidad -->
            <div class="position-absolute top-0 start-0 p-2 d-flex flex-column align-items-start" style="z-index: 10; width: auto; max-width: 100%;">
              <% if product.offer_type.present? %>
                <span class="badge bg-danger text-uppercase mb-1" style="white-space: nowrap;"><%= product.offer_type %></span>
              <% end %>
              <% if product.quantity > 0 %>
                <span class="badge bg-success mb-1" style="white-space: nowrap;">Disponible</span>
              <% else %>
                <span class="badge bg-secondary mb-1" style="white-space: nowrap;">Agotado</span>
              <% end %>
            </div>

            <!-- Carrusel -->
            <div class="product-carousel" data-images="<%= images.join('|') %>">
              <img class="carousel-img" src="<%= images.first || 'https://via.placeholder.com/300x220?text=Sin+imagen' %>" alt="<%= product.name %>">
              <% if images.size > 1 %>
                <button class="carousel-btn prev-btn">&lt;</button>
                <button class="carousel-btn next-btn">&gt;</button>
              <% end %>
            </div>

            <!-- Body de la card -->
            <div class="card-body d-flex flex-column p-3">
              <h6 class="card-title text-dark fw-bold text-truncate mb-1"><%= product.name %></h6>
              <p class="card-text text-muted small mb-2"><%= truncate(product.description, length: 60) %></p>

              <div class="mt-auto">
                <% if product.discount.to_i > 0 && product.on_offer? %>
                  <p class="mb-1 small text-muted text-decoration-line-through"><%= number_to_currency(product.price) %></p>
                  <p class="fw-bold text-success mb-0"><%= number_to_currency(product.discounted_price) %> (-<%= product.discount %>%)</p>
                <% else %>
                  <p class="fw-bold text-dark mb-0"><%= number_to_currency(product.price) %></p>
                <% end %>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted"><%= product.category&.name %></small>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="col-12 text-center mt-4"><p class="text-muted">No se encontraron productos.</p></div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('.product-carousel').forEach(carousel => {
    const imgEl = carousel.querySelector('.carousel-img');
    const nextBtn = carousel.querySelector('.next-btn');
    const prevBtn = carousel.querySelector('.prev-btn');
    const images = carousel.dataset.images.split('|');
    let index = 0;
    let interval;

    const showImage = i => imgEl.src = images[i];

    if(nextBtn) nextBtn.addEventListener('click', e => { e.stopPropagation(); index = (index+1) % images.length; showImage(index); });
    if(prevBtn) prevBtn.addEventListener('click', e => { e.stopPropagation(); index = (index-1+images.length)%images.length; showImage(index); });

    carousel.addEventListener('mouseenter', () => {
      if(images.length>1) interval = setInterval(()=>{ index=(index+1)%images.length; showImage(index); },1500);
    });
    carousel.addEventListener('mouseleave', () => clearInterval(interval));
  });
});
</script>

<style>
.product-carousel {
  position: relative;
  width: 100%;
  height: 250px;
  overflow: hidden;
}
.carousel-img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.carousel-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-weight: bold;
  padding: 0.3rem 0.6rem;
  cursor: pointer;
  border-radius: 3px;
  z-index: 10;
}
.prev-btn { left: 5px; }
.next-btn { right: 5px; }
.card-title { font-size: 0.95rem; }
.card-text { font-size: 0.8rem; line-height:1.3; }
.badge.small { font-size:0.7rem; padding:0.25rem 0.4rem; }
</style>
