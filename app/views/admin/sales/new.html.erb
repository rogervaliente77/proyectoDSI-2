<!-- Begin Page Content -->
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
        
        <%= link_to admin_sales_path, class: "d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" do %>
          <i class="fas fa-arrow-left fa-sm text-white-50"></i> Volver a ventas
        <% end %>
    </div>

    <!-- Content Row -->

    <div class="row">
        <!-- Area Chart -->
        <div class="col-12">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Venta nueva</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                            aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Dropdown Header:</div>
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                </div>
                <!-- Card Body -->
                <div class="card-body">

                    <% if flash[:notice] %>
                    <div class="alert alert-success"><%= flash[:notice] %></div>
                    <% elsif flash[:alert] %>
                    <div class="alert alert-danger"><%= flash[:alert] %></div>
                    <% end %>

                    
                    <%= simple_form_for :sale, url: admin_sales_create_path, method: :post, html: { class: "needs-validation", id: "form-control", novalidate: false }, data: { turbo: false } do |form| %> 
                        <div class="row">
                          <div class="col-sm-4 mb-3">
                            <%= form.input :client_name, label: "Nombre del cliente", required: true, input_html: { class: "form-control" } %>
                          </div>

                          <% if @current_user.role.name == "cajero" %>
                            <% cajero = Cajero.find_by(user_id: @current_user.id) %>
                            <% if cajero.present? && cajero.caja.present? %>
                              <div class="col-sm-4 mb-3">
                                <%= form.input :cajero_id,
                                      label: "Cajero",
                                      as: :string,
                                      input_html: {
                                        value: cajero.nombre,
                                        readonly: true,
                                        class: "form-control"
                                      } %>
                                <%= form.hidden_field :cajero_id, value: cajero.id %>
                              </div>

                              <div class="col-sm-4 mb-3">
                                <%= form.input :caja_id,
                                      label: "Caja",
                                      as: :string,
                                      input_html: {
                                        value: cajero.caja.nombre,
                                        readonly: true,
                                        class: "form-control"
                                      } %>
                                <%= form.hidden_field :caja_id, value: cajero.caja.id %>
                              </div>
                            <% end %>
                          <% end %>
                        </div>

                        <div class="mb-3 text-right">
                            <a class="btn btn-primary btn-sm" href="#" data-toggle="modal" data-target="#productModal">
                                <i class="fas fa-plus fa-sm text-white-50"></i> Agregar producto
                            </a>
                        </div>

                        <!-- Tabla de productos agregados -->
                        <table class="table table-bordered">
                        <thead>
                            <tr>
                              <th>Producto</th>
                              <th>Cantidad</th>
                              <th>Precio Unitario</th>
                              <th>Descuento %</th>
                              <th>Tipo de oferta</th>
                              <th>Valor del Descuento </th>
                              <th>Subtotal</th>
                              <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="product-sales-container">
                            <!-- Aquí se insertan dinámicamente los productos -->
                        </tbody>
                        </table>

                        <div class="text-right">
                          <h5>Total: $<span id="sale-total">0.00</span></h5>
                        </div>

                        <%= form.hidden_field :total_amount, id: "sale_total_amount" %>

                        <% if current_user.role.name == 'cajero' %>
                          <div class="form-group mt-4">
                            <%= form.submit 'Confirmar venta', class: 'btn btn-success' %>
                          </div>
                        <% end %>
                    <% end %>

                    <!-- Modal de productos -->
                    <div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="productModalLabel">Buscar producto</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <input type="text" id="search-product-input" class="form-control" placeholder="Buscar por nombre...">
                            </div>

                            <table class="table table-striped">
                              <thead>
                                <tr>
                                  <th>Nombre</th>
                                  <th>Descripción</th>
                                  <th>Precio</th>
                                  <th>Oferta?</th>
                                  <th>Acciones</th>
                                </tr>
                              </thead>
                              <tbody id="product-search-results">
                                <!-- Aquí se renderizan los resultados -->
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>                     
    </div>
</div>
<!-- /.container-fluid -->

<script>
document.addEventListener("DOMContentLoaded", () => {
  let productIndex = 0;

  // Buscar productos en el modal
  document.getElementById("search-product-input").addEventListener("keyup", async function () {
    const query = this.value;
    if (query.length < 2) return;

    const response = await fetch(`/admin/products/search.json?q=${query}`);
    const products = await response.json();

    const resultsContainer = document.getElementById("product-search-results");
    resultsContainer.innerHTML = "";

    products.forEach(product => {
      resultsContainer.innerHTML += `
        <tr>
          <td>${product.name}</td>
          <td>${product.description}</td>
          <td>$${product.price}</td>
          <td>
            ${
              product.offer_type
                ? `<span class="badge badge-info">${product.offer_type}</span>
                  ${
                    product.offer_type === 'mayoreo'
                      ? `<br><small>A partir de ${product.wholesale_quantity} unidades</small>`
                      : ''
                  }`
                : `<span class="badge badge-danger">N/A</span>`
            }
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-success select-product-btn"
                    data-id="${product.id}"
                    data-name="${product.name}"
                    data-price="${product.price}"
                    data-discount="${product.discount || 0}"
                    data-offer-type="${product.offer_type || ''}"
                    data-wholesale-quantity="${product.wholesale_quantity || 0}">
              Seleccionar
            </button>
          </td>
        </tr>
      `;
    });
  });

  // Agregar producto desde el modal
  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("select-product-btn")) {
      const id = e.target.dataset.id;
      const name = e.target.dataset.name;
      const price = e.target.dataset.price;
      const discount = e.target.dataset.discount || 0;
      const offerType = e.target.dataset.offerType || '';
      const wholesaleQuantity = e.target.dataset.wholesaleQuantity || 0;

      const container = document.getElementById("product-sales-container");

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${name}</td>
        <td>
          <input type="number" name="sale[product_sales_attributes][${productIndex}][quantity]" value="1" class="form-control" min="1">
        </td>
        <td>
          <input type="number" name="sale[product_sales_attributes][${productIndex}][unit_price]" value="${price}" class="form-control" readonly>
        </td>
        <td>
          <input type="number" name="sale[product_sales_attributes][${productIndex}][discount]" value="${discount}" class="form-control" readonly data-original-discount="${discount}">
        </td>

        <td class="offer_type-value">
          ${offerType ? `<span class="badge badge-info">${offerType}</span>` : '<span class="badge badge-secondary">N/A</span>'}
          <input type="hidden" name="sale[product_sales_attributes][${productIndex}][offer_type]" value="${offerType}">
          <input type="hidden" class="wholesale-quantity" value="${wholesaleQuantity}">
        </td>

        <td class="discount-value">0.00</td>
        <td class="subtotal">0.00</td>
        <input type="hidden" name="sale[product_sales_attributes][${productIndex}][subtotal]" value="0.00" class="subtotal-input">

        <td>
          <button type="button" class="btn btn-danger btn-sm remove-product">Eliminar</button>
        </td>
        <input type="hidden" name="sale[product_sales_attributes][${productIndex}][product_id]" value="${id}">
      `;
      container.appendChild(row);
      updateSaleTotal();

      productIndex++;
      bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    }

    // Eliminar producto
    if (e.target.classList.contains("remove-product")) {
      e.target.closest("tr").remove();
      updateSaleTotal();
    }
  });

  // Detectar cambios en inputs de cantidad
  document.addEventListener("input", function (e) {
    if (e.target.name?.includes("quantity")) {
      updateSaleTotal();
    }
  });

  function updateSaleTotal() {
  let total = 0;
  const rows = document.querySelectorAll("#product-sales-container tr");

  rows.forEach(row => {
    const quantityInput = row.querySelector('input[name*="[quantity]"]');
    const priceInput = row.querySelector('input[name*="[unit_price]"]');
    const discountInput = row.querySelector('input[name*="[discount]"]');
    const offerType = row.querySelector('input[name*="[offer_type]"]').value;
    const wholesaleQuantity = parseFloat(row.querySelector(".wholesale-quantity")?.value || 0);
    const subtotalInput = row.querySelector('.subtotal-input');

    const quantity = parseFloat(quantityInput?.value || 0);
    const price = parseFloat(priceInput?.value || 0);
    const originalDiscount = parseFloat(discountInput?.dataset.originalDiscount || 0);

    let discountValue = 0;
    let subtotal = 0;
    const value = quantity * price;

    switch (offerType) {
      case "mayoreo":
        if (quantity >= wholesaleQuantity && wholesaleQuantity > 0) {
          discountValue = value * (originalDiscount / 100);
        } else {
          discountValue = 0;
        }
        break;

      case "2x1":
        discountValue = Math.floor(quantity / 2) * price;
        break;

      case "3x1":
        discountValue = Math.floor(quantity / 3) * price;
        break;

      case "descuento":
        discountValue = value * (originalDiscount / 100);
        break;

      default:
        discountValue = 0;
    }

    subtotal = value - discountValue;

    // Actualizar input que se envía al backend con el valor real del descuento
    discountInput.value = discountValue.toFixed(2);

    // Actualizar la columna % Descuento visual
    const discountPercentageCell = row.querySelector(".discount-percentage");
    if (discountPercentageCell) {
      if (offerType === "2x1" || offerType === "3x1") {
        discountPercentageCell.textContent = "0%";
      } else {
        discountPercentageCell.textContent = originalDiscount.toFixed(2) + "%";
      }
    }

    row.querySelector(".discount-value").textContent = discountValue.toFixed(2);
    row.querySelector(".subtotal").textContent = subtotal.toFixed(2);
    if(subtotalInput) subtotalInput.value = subtotal.toFixed(2);

    total += subtotal;
  });

  document.getElementById("sale-total").textContent = total.toFixed(2);
  document.getElementById("sale_total_amount").value = total.toFixed(2);
}



});
</script>
