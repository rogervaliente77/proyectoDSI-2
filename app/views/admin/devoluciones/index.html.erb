<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Listado de Devoluciones</h1>
    <%= link_to new_admin_devolucione_path, class: "btn btn-primary shadow-sm", data: { turbo: false } do %>
      <i class="fas fa-plus-circle me-2"></i> Nueva Devolución
    <% end %>
  </div>

  <% if flash[:notice] %>
  <div class="alert alert-success"><%= flash[:notice] %></div>
  <% elsif flash[:alert] %>
  <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <% if @devoluciones.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle shadow-sm rounded">
        <thead class="table-dark text-center">
          <tr>
            <th>Cliente</th>
            <th>Fecha de Devolución</th>
            <th>Comentarios</th>
            <th>Caja</th>
            <th>Cajero</th>
            <th>Venta Asociada</th>
            <th>Autorizada?</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% @devoluciones.each do |devolucion| %>
            <tr>
              <td><%= devolucion.client_name.presence || "—" %></td>
              <td class="text-center"><%= devolucion.fecha_devolucion&.strftime("%d/%m/%Y %H:%M") || "—" %></td>
              <td class="text-muted"><%= devolucion.comments_devolucion.presence || "Sin comentarios" %></td>
              <td class="text-center"><%= devolucion.caja&.nombre || "—" %></td>
              <td class="text-center"><%= devolucion.cajero&.nombre || "—" %></td>
              <td class="text-center"><%= devolucion.sale&.code || "—" %></td>
              <td class="text-center align-middle">
                <% if devolucion.is_authorized %>
                  <button class="btn btn-success btn-sm" disabled>
                    <i class="fas fa-check-circle"></i> Autorizada
                  </button>
                <% else %>
                  <% if @current_user.role.name.in?(["super_admin", "admin"]) %>
                    <%= button_to autorizar_devolucion_admin_devolucione_path(devolucion),
                          method: :patch,
                          class: "btn btn-warning btn-sm",
                          data: { turbo: false, confirm: "¿Autorizar esta devolución?" } do %>
                      <i class="fas fa-check"></i> Autorizar
                    <% end %>
                  <% else %>
                    <button class="btn btn-secondary btn-sm" disabled>
                      <i class="fas fa-lock"></i> No autorizado
                    </button>
                  <% end %>
                <% end %>
              </td>
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2">
                  <!-- Editar -->
                  <%= link_to edit_admin_devolucione_path(devolucion), class: "btn btn-outline-warning btn-sm", title: "Editar", data: { bs_toggle: "tooltip", bs_placement: "top" } do %>
                    <i class="fas fa-edit"></i>
                  <% end %>

                  <!-- Eliminar -->
                  <%= button_to admin_devolucione_path(devolucion),
                        method: :delete,
                        form: { class: "d-inline" },
                        data: { turbo_confirm: "¿Seguro que deseas eliminar esta devolución?", bs_toggle: "tooltip", bs_placement: "top" },
                        class: "btn btn-outline-danger btn-sm" do %>
                    <i class="fas fa-trash-alt"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info text-center shadow-sm">
      No hay devoluciones registradas.
    </div>
  <% end %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
  });
</script>
