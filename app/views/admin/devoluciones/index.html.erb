<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Listado de Devoluciones</h1>
    <%= link_to new_admin_devolucione_path, class: "btn btn-primary shadow-sm", data: { turbo: false }, title: "Nueva Devolución", data: { bs_toggle: "tooltip" } do %>
      <i class="fas fa-plus-circle"></i>
    <% end %>
  </div>

  <!-- FILTROS DE FECHA Y BOTÓN DE REPORTE -->
  <div class="card mb-4 shadow-sm border-0">
    <div class="card-body">
      <%= form_with url: admin_devoluciones_path, method: :get, local: true, class: "row g-3 align-items-end" do %>
        <div class="col-md-4">
          <%= label_tag :start_date, "Desde", class: "form-label fw-semibold" %>
          <%= date_field_tag :start_date, params[:start_date], class: "form-control" %>
        </div>
        <div class="col-md-4">
          <%= label_tag :end_date, "Hasta", class: "form-label fw-semibold" %>
          <%= date_field_tag :end_date, params[:end_date], class: "form-control" %>
        </div>
        <div class="col-md-4 d-flex gap-2">
          <!-- Botón Filtrar solo icono -->
          <%= button_tag type: "submit", class: "btn btn-outline-primary flex-fill", title: "Filtrar", data: { bs_toggle: "tooltip" } do %>
          <i class="fas fa-filter"></i>
          <% end %>
          
          <!-- Botón de descarga del reporte solo icono -->
          <%= link_to generate_report_admin_devoluciones_path(
                start_date: params[:start_date],
                end_date: params[:end_date]
              ),
              target: "_blank",
              class: "btn btn-danger flex-fill fas fa-file-pdf",
              data: { turbo: false, bs_toggle: "tooltip" },
              title: "Descargar reporte" do %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <!-- FIN DE FILTROS -->

  <% if flash[:notice] %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% elsif flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <% if @devoluciones.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle shadow-sm rounded">
        <thead class="table-dark text-center">
          <tr>
            <th>Cliente</th>
            <th>Fecha de Devolución</th>
            <th>Comentarios</th>
            <th>Caja</th>
            <th>Cajero</th>
            <th>Venta Asociada</th>
            <th>Autorizada?</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% @devoluciones.each do |devolucion| %>
            <tr>
              <td><%= devolucion.client_name.presence || "—" %></td>
              <td class="text-center"><%= devolucion.fecha_devolucion&.strftime("%d/%m/%Y %H:%M") || "—" %></td>
              <td class="text-muted"><%= devolucion.comments_devolucion.presence || "Sin comentarios" %></td>
              <td class="text-center"><%= devolucion.caja&.nombre || "—" %></td>
              <td class="text-center"><%= devolucion.cajero&.nombre || "—" %></td>
              <td class="text-center"><%= devolucion.sale&.code || "—" %></td>
              
              <!-- Columna Autorizada -->
              <td class="text-center align-middle">
                <% if devolucion.is_authorized %>
                  <button class="btn btn-success btn-sm fas fa-check-circle" disabled title="Autorizada" data-bs-toggle="tooltip"></button>
                <% else %>
                  <% if @current_user.role.name.in?(["super_admin", "admin"]) %>
                    <%= button_to autorizar_devolucion_admin_devolucione_path(devolucion),
                          method: :patch,
                          class: "btn btn-warning btn-sm fas fa-check",
                          data: { turbo: false, confirm: "¿Autorizar esta devolución?", bs_toggle: "tooltip" },
                          title: "Autorizar" do %>
                    <% end %>
                  <% else %>
                    <button class="btn btn-secondary btn-sm fas fa-lock" disabled title="No autorizado" data-bs-toggle="tooltip"></button>
                  <% end %>
                <% end %>
              </td>

              <!-- Columna Acciones -->
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2">
                  <!-- Editar solo icono -->
                  <%= link_to edit_admin_devolucione_path(devolucion),
                        class: "btn btn-outline-warning btn-sm fas fa-edit",
                        title: "Editar",
                        data: { bs_toggle: "tooltip", bs_placement: "top" } do %>
                  <% end %>

                  <!-- Eliminar solo icono -->
                  <%= button_to admin_devolucione_path(devolucion),
                        method: :delete,
                        form: { class: "d-inline" },
                        class: "btn btn-outline-danger btn-sm fas fa-trash-alt",
                        data: { turbo_confirm: "¿Seguro que deseas eliminar esta devolución?", bs_toggle: "tooltip", bs_placement: "top" },
                        title: "Eliminar" do %>
                  <% end %>

                  <!-- Comprobante PDF solo icono -->
                  <%= link_to generate_pdf_admin_devolucione_path(devolucion),
                        target: "_blank",
                        class: "btn btn-danger btn-sm fas fa-download",
                        data: { turbo: false, bs_toggle: "tooltip" },
                        title: "Comprobante" do %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info text-center shadow-sm">
      No hay devoluciones registradas.
    </div>
  <% end %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
  });
</script>
