<div class="container mt-4">
  <h1>✏️ Editar Devolución</h1>

    <%= form_with(url: admin_devolucione_path(@devolucion), model: @devolucion, local: true) do |f| %>
    <% if @devolucion.errors.any? %>
      <div class="alert alert-danger">
        <h4>Errores:</h4>
        <ul>
          <% @devolucion.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= f.label :client_name, "Cliente" %>
      <%= f.text_field :client_name, class: "form-control", placeholder: "Nombre del cliente" %>
    </div>

    <!-- Selector de Venta -->
    <div class="form-group">
      <%= f.label :sale_id, "Venta" %>
      <%= f.collection_select :sale_id, Sale.all, :id, :code, 
            { prompt: "Seleccione una venta con productos disponibles" }, 
            { class: "form-control", id: "sale_selector" } %>
    </div>

    <!-- Selector de Productos a devolver -->
    <div class="form-group">
      <%= f.label :sale_devolucion_detalle, "Productos a devolver" %>
      <%= f.collection_select :sale_devolucion_detalle, [], :id, :product_name, 
            { prompt: "Seleccione una venta primero" }, 
            { class: "form-control", id: "products_selector", multiple: true } %>
    </div>

    <div class="form-group">
      <%= f.label :caja_id, "Caja" %>
      <%= f.collection_select :caja_id, Caja.all, :id, :nombre, { prompt: "Seleccione la caja" }, { class: "form-control" } %>
    </div>

    <div class="form-group">
      <%= f.label :cajero_id, "Cajero" %>
      <%= f.collection_select :cajero_id, Cajero.all, :id, :nombre, { prompt: "Seleccione el cajero" }, { class: "form-control" } %>
    </div>

    <div class="form-group">
      <%= f.label :fecha_devolucion, "Fecha de Devolución" %>
      <%= f.datetime_field :fecha_devolucion, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :comments_devolucion, "Comentarios" %>
      <%= f.text_area :comments_devolucion, class: "form-control", rows: 3 %>
    </div>

    <div class="mt-3">
      <%= f.submit "Actualizar Devolución", class: "btn btn-success" %>
      <%= link_to "Cancelar", admin_devoluciones_path, class: "btn btn-secondary" %>
    </div>
  <% end %>
</div>

<!-- Script para cargar productos dinámicamente según la venta seleccionada -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const saleSelector = document.getElementById("sale_selector");
    const productsSelector = document.getElementById("products_selector");

    saleSelector.addEventListener("change", async () => {
      const saleId = saleSelector.value;
      if (!saleId) {
        productsSelector.innerHTML = "<option>Seleccione una venta primero</option>";
        return;
      }

      const response = await fetch(`/admin/sales/${saleId}/available_products`);
      const products = await response.json();

      productsSelector.innerHTML = "";
      products.forEach(product => {
        const option = document.createElement("option");
        option.value = product.id;
        option.text = `${product.name} (Cantidad: ${product.quantity})`;
        productsSelector.appendChild(option);
      });
    });

    // Cargar productos previamente seleccionados si es edit
    if (<%= @devolucion.sale_devolucion_detalle.present? %>) {
      Array.from(productsSelector.options).forEach(opt => {
        if (<%= @devolucion.sale_devolucion_detalle.map(&:to_s) %>.includes(opt.value)) {
          opt.selected = true;
        }
      });
    }
  });
</script>
