<div class="container-fluid py-5">

  <!-- Título y subtítulo -->
  <div class="mb-4 text-center text-md-start">
    <h1 class="mb-1">Reporte de Mejores Vendedores</h1>
    <p class="text-muted mb-0">Consulta los vendedores con mayor volumen de ventas e ingresos generados.</p>
  </div>

  <!-- Botón regresar -->
  <div class="mb-3">
    <a href="/admin/reports" class="btn btn-outline-secondary">&larr; Volver a Reportes</a>
  </div>

  <!-- Filtros -->
  <div class="row g-3 mb-4 align-items-end">
    <div class="col-md-8">
      <%= form_with url: '/admin/reports/best_seller', method: :get, local: true, class: 'row g-2 align-items-end' do |f| %>
        <div class="col-md-4">
          <label>Fecha inicio</label>
          <%= f.date_field :start_date, value: params[:start_date], class: 'form-control' %>
        </div>
        <div class="col-md-4">
          <label>Fecha fin</label>
          <%= f.date_field :end_date, value: params[:end_date], class: 'form-control' %>
        </div>
        <div class="col-md-4 d-flex gap-2">
          <%= f.submit 'Aplicar filtros', class: 'btn btn-primary w-50' %>
          <a href="/admin/reports/best_seller" class="btn btn-secondary w-50">Reiniciar filtros</a>
        </div>
      <% end %>
    </div>

    <div class="col-md-4 text-md-end">
      <button class="btn btn-success" onclick="exportTableToExcel('sellersTable', 'mejores_vendedores')">
        Exportar a Excel
      </button>
      <button class="btn btn-danger ms-2" onclick="exportTableAndChartToPDF('sellersTable', 'topSellersChart', 'mejores_vendedores')">
        Descargar PDF
      </button>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <canvas id="topSellersChart" width="1000" height="400"></canvas>
    </div>
  </div>

  <!-- Resumen -->
  <div class="row mb-4">
    <div class="col-md-6 mb-2">
      <div class="card shadow-sm border-light text-center p-3">
        <h6>Total de unidades vendidas</h6>
        <p class="fs-5 mb-0"><%= @total_units_sold %></p>
      </div>
    </div>
    <div class="col-md-6 mb-2">
      <div class="card shadow-sm border-light text-center p-3">
        <h6>Total de ingresos</h6>
        <p class="fs-5 mb-0">$<%= number_with_precision(@total_revenue, precision: 2) %></p>
      </div>
    </div>
  </div>

  <!-- Tabla de vendedores -->
  <div class="table-responsive mb-3">
    <table class="table table-sm table-striped table-hover table-bordered" id="sellersTable">
      <thead class="table-dark">
        <tr>
          <th>Fecha</th>
          <th>Vendedor</th>
          <th>Unidades Vendidas</th>
          <th>Ingreso Total</th>
        </tr>
      </thead>
      <tbody>
        <% @sellers_sales.each do |s| %>
          <tr>
            <td><%= s["_id"]["date"] %></td>
            <td><%= s["_id"]["vendedor_nombre"] %></td>
            <td class="text-end"><%= s["total_sold"] %></td>
            <td class="text-end">$<%= number_with_precision(s["total_revenue"], precision: 2) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center" id="paginationSellers"></ul>
  </nav>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
  window.topSellersChart = window.topSellersChart || null;

  // Exportar tabla a Excel
  function exportTableToExcel(tableID, filename='') {
    const table = document.getElementById(tableID);
    const template = `<html xmlns:o="urn:schemas-microsoft-com:office:office" 
        xmlns:x="urn:schemas-microsoft-com:office:excel" 
        xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="UTF-8"></head><body>${table.outerHTML}</body></html>`;
    const uri = 'data:application/vnd.ms-excel;base64,';
    const link = document.createElement("a");
    link.href = uri + window.btoa(unescape(encodeURIComponent(template)));
    link.download = filename ? filename+'.xls' : 'excel_data.xls';
    link.click();
  }

  // Exportar tabla + gráfico a PDF (igual que Top Brands)
  function exportTableAndChartToPDF(tableID, canvasID, filename='') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'pt', 'a4');

    // Tabla
    const table = document.getElementById(tableID);
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
    const data = Array.from(table.querySelectorAll('tbody tr')).map(tr =>
      Array.from(tr.cells).map(td => td.textContent)
    );

    doc.autoTable({
      head: [headers],
      body: data,
      startY: 50,
      theme: 'striped',
      headStyles: { fillColor: [52, 58, 64] },
      styles: { fontSize: 10 }
    });

    // Gráfico
    const canvas = document.getElementById(canvasID);
    if (canvas) {
      const imgData = canvas.toDataURL('image/png');
      const pdfWidth = doc.internal.pageSize.getWidth() - 40;
      const pdfHeight = (canvas.height / canvas.width) * pdfWidth;
      doc.addPage();
      doc.addImage(imgData, 'PNG', 20, 40, pdfWidth, pdfHeight);
    }

    doc.save(filename ? filename + '.pdf' : 'reporte.pdf');
  }

  // Inicializar gráfico
  function initializeSellersChart() {
    const table = document.getElementById('sellersTable');
    const canvas = document.getElementById('topSellersChart');
    if (!table || !canvas) return;

    const rows = Array.from(table.querySelectorAll('tbody tr'));
    if (rows.length === 0) return;

    const chartData = rows.map(r => ({
      label: r.cells[1].textContent.trim(),
      value: parseInt(r.cells[2].textContent.replace(/,/g,'')) || 0
    })).sort((a,b)=>b.value-a.value);

    const labels = chartData.map(d => d.label);
    const data = chartData.map(d => d.value);
    const maxValue = Math.max(...data) * 1.2;

    if (window.topSellersChart && typeof window.topSellersChart.destroy === 'function') {
      window.topSellersChart.destroy();
    }

    const ctx = canvas.getContext('2d');
    window.topSellersChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Unidades Vendidas',
          data: data,
          backgroundColor: labels.map(() => `rgba(${Math.floor(Math.random()*255)}, ${Math.floor(Math.random()*200)}, ${Math.floor(Math.random()*255)}, 0.7)`),
          borderColor: '#333',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Mejores Vendedores' },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw} unidades` } }
        },
        scales: { y: { beginAtZero: true, max: maxValue } }
      }
    });

    // Paginación
    const rowsPerPage = 10;
    const pagination = document.getElementById('paginationSellers');
    let currentPage = 1;
    const totalPages = Math.ceil(rows.length / rowsPerPage);

    function showPage(page){
      currentPage = page;
      const start = (page-1)*rowsPerPage;
      const end = start+rowsPerPage;
      rows.forEach((r,i)=>r.style.display=(i>=start && i<end)?'':'none');
      renderPagination();
    }

    function renderPagination(){
      pagination.innerHTML='';
      for(let i=1;i<=totalPages;i++){
        const li=document.createElement('li');
        li.className=`page-item ${i===currentPage?'active':''}`;
        const a=document.createElement('a');
        a.className='page-link';
        a.href='javascript:void(0)';
        a.textContent=i;
        a.addEventListener('click',()=>showPage(i));
        li.appendChild(a);
        pagination.appendChild(li);
      }
    }

    if(rows.length>rowsPerPage) showPage(1);
    else rows.forEach(r=>r.style.display='');
  }

  document.addEventListener('DOMContentLoaded', () => setTimeout(initializeSellersChart, 100));
</script>
