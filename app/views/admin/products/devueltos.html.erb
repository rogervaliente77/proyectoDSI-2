<div class="container-fluid py-4">
  <h1 class="h3 text-dark fw-bold mb-4">ðŸ“¦ Productos devueltos</h1>

  <div class="card shadow-sm rounded">
    <table class="table table-hover table-bordered align-middle mb-0">
      <thead class="table-dark text-white text-center">
        <tr>
          <th>CÃ³digo</th>
          <th>Nombre</th>
          <th>CategorÃ­a</th>
          <th>Marca</th>
          <th>Precio</th>
          <th>Descuento</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody id="returned_products_body">
        <% if @returned_products.any? %>
          <% @returned_products.each do |rp| %>
            <tr>
              <td class="text-center"><%= rp.product.code %></td>
              <td class="fw-semibold"><%= rp.product.name %></td>
              <td><%= rp.product.category&.name || "â€”" %></td>
              <td><%= rp.product.marca&.name || "â€”" %></td>
              <td class="text-center"><%= number_to_currency(rp.unit_price) %></td>
              <td class="text-center"><%= rp.discount || 0 %>%</td>
              <td class="text-center">
                <input type="number"
                       class="form-control form-control-sm text-center returned-quantity"
                       value="<%= rp.quantity %>"
                       readonly>
              </td>
              <td class="text-center subtotal"><%= number_to_currency(rp.unit_price * rp.quantity) %></td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              No hay productos devueltos
            </td>
          </tr>
        <% end %>
      </tbody>
      <% if @returned_products.any? %>
        <tfoot class="table-light fw-bold">
          <tr>
            <td colspan="6" class="text-end">Totales:</td>
            <td class="text-center" id="total_cantidad"><%= @total_cantidad %></td>
            <td class="text-center" id="total_valor"><%= number_to_currency(@total_valor) %></td>
          </tr>
        </tfoot>
      <% end %>
    </table>
  </div>
</div>

<!-- Opcional: Script para actualizar totales si alguna cantidad cambia dinÃ¡micamente -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    function actualizarTotales() {
      let totalCantidad = 0;
      let totalValor = 0;
      document.querySelectorAll("#returned_products_body tr").forEach(row => {
        const qtyInput = row.querySelector(".returned-quantity");
        if (!qtyInput) return;
        const qty = parseFloat(qtyInput.value) || 0;
        const precio = parseFloat(row.querySelector(".subtotal").textContent.replace(/[^0-9.-]+/g,"")) / qty || 0;
        const subtotal = qty * precio;
        row.querySelector(".subtotal").textContent = "$" + subtotal.toFixed(2);
        totalCantidad += qty;
        totalValor += subtotal;
      });
      document.getElementById("total_cantidad").textContent = totalCantidad;
      document.getElementById("total_valor").textContent = "$" + totalValor.toFixed(2);
    }

    // Escuchar cambios en cantidad si se quiere permitir ediciÃ³n
    document.querySelectorAll(".returned-quantity").forEach(input => {
      input.addEventListener("input", actualizarTotales);
    });
  });
</script>
