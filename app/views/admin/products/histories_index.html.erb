<div class="container-fluid mt-5">
  <!-- üîπ Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-gradient fw-bold" style="background: linear-gradient(90deg,#0d6efd,#6610f2); -webkit-background-clip: text; color: transparent;">
      <i class="fas fa-warehouse me-2"></i> Movimiento de Inventario
    </h1>
    <%= link_to "Volver a Productos", admin_productos_path, class: "btn btn-outline-primary fw-bold shadow-sm" %>
  </div>

  <!-- üîπ Filtros por usuario y fecha -->
  <div class="d-flex justify-content-start align-items-center mb-3 no-print gap-2">
    <%= form_with url: admin_product_histories_path, method: :get, local: true, class: "d-flex gap-2" do |f| %>
      <div>
        <%= f.label :user_name, "Buscar Usuario", class: "form-label small fw-bold" %>
        <%= f.text_field :user_name, value: params[:user_name], placeholder: "Nombre o apellido", class: "form-control" %>
      </div>
      <div>
        <%= f.label :start_date, "Fecha Inicio", class: "form-label small fw-bold" %>
        <%= f.date_field :start_date, value: params[:start_date], class: "form-control" %>
      </div>
      <div>
        <%= f.label :end_date, "Fecha Fin", class: "form-label small fw-bold" %>
        <%= f.date_field :end_date, value: params[:end_date], class: "form-control" %>
      </div>
      <div class="align-self-end d-flex gap-2">
        <%= f.submit "Filtrar", class: "btn btn-primary mt-2" %>
        <%= link_to "Reiniciar", admin_product_histories_path, class: "btn btn-secondary mt-2" %>
      </div>
    <% end %>
  </div>

  <!-- üîπ Botones de imprimir y exportar -->
  <div class="d-flex justify-content-end mb-3 no-print">
    <button class="btn btn-primary me-2" onclick="window.print()">
      <i class="fas fa-print me-1"></i> Imprimir
    </button>
    <button class="btn btn-success" id="exportExcel">
      <i class="fas fa-file-excel me-1"></i> Exportar a Excel
    </button>
  </div>

  <!-- üîπ Card principal -->
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-borderless align-middle mb-0" style="min-width: 1200px;">
          <thead class="bg-gradient text-white text-uppercase small">
            <tr>
              <th>Producto</th>
              <th>C√≥digo</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>% Descuento</th>
              <th>Stock antes</th>
              <th>Stock actual</th>
              <th>Tipo</th>
              <th>Usuario</th>
              <th>Fecha</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @product_histories.each do |history| %>
              <tr class="align-middle" style="transition: background 0.2s, transform 0.2s;">
                <td class="fw-semibold"><%= history.name %></td>
                <td class="text-monospace text-muted"><%= history.code.presence || '-' %></td>
                <td>
                  <% if history.movement_type.in?(["Ingreso", "Ingreso inicial"]) %>
                    <span class="badge bg-success text-white fw-bold"><i class="fas fa-arrow-up me-1"></i><%= history.quantity %></span>
                  <% else %>
                    <span class="badge bg-danger text-white fw-bold"><i class="fas fa-arrow-down me-1"></i><%= history.quantity %></span>
                  <% end %>
                </td>
                <td><span class="fw-medium text-primary"><%= number_to_currency(history.price) %></span></td>
                <td><span class="text-muted"><%= history.discount %> %</span></td>
                <td><span class="text-secondary"><%= history.stock_before %></span></td>
                <td><span class="fw-bold text-success"><%= history.current_stock %></span></td>
                <td>
                  <% if history.sale_id.present? %>
                    <span class="badge bg-success"><i class="fas fa-shopping-cart me-1"></i>Venta</span>
                  <% elsif history.devolucion_id.present? %>
                    <span class="badge bg-warning text-dark"><i class="fas fa-undo me-1"></i>Devoluci√≥n</span>
                  <% else %>
                    <span class="badge bg-secondary"><i class="fas fa-exchange-alt me-1"></i>Ajuste</span>
                  <% end %>
                </td>
                <td><%= history.user.present? ? "#{history.user.first_name} #{history.user.last_name}" : "Sistema" %></td>
                <td><span class="text-muted"><%= history.created_at.strftime("%d/%m/%Y %H:%M") %></span></td>
                <td class="text-center no-print">
                  <%= link_to admin_product_history_path(history), class: "btn btn-sm btn-info rounded-circle shadow-sm", title: "Ver detalle" do %>
                    <i class="fas fa-eye"></i>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- üîπ Estilos adicionales -->
<style>
  table.table-hover tbody tr:hover { background-color: #e9f2ff; transform: translateX(2px); }
  thead.bg-gradient { background: linear-gradient(90deg, #0d6efd, #6610f2); }
  .badge { font-size: 0.85rem; padding: 0.45em 0.7em; border-radius: 0.5rem; }
  td.text-monospace { font-family: 'Courier New', Courier, monospace; }
  .card { border: 1px solid #e3e6f0; }

  @media print {
    .btn, .no-print { display: none !important; }
    .shadow-sm, .shadow-lg { box-shadow: none !important; }
    .card { border: none !important; }
    .container-fluid { padding: 0 !important; width: 100%; }
    table { width: 100% !important; font-size: 12px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; }
    tr { page-break-inside: avoid; }
    @page { size: letter portrait; margin: 1cm; }
  }
</style>

<!-- üîπ Script para exportar Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  document.getElementById("exportExcel").addEventListener("click", function() {
    var table = document.querySelector("table");
    var wb = XLSX.utils.table_to_book(table, {sheet:"Movimiento de Inventario"});
    XLSX.writeFile(wb, "movimiento_inventario.xlsx");
  });
</script>
