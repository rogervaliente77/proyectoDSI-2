<!-- app/views/admin/products/_form_fields.html.erb -->
<!-- Datos básicos -->
<div class="row mb-3">
  <div class="col-sm-4">
    <%= form.input :name, required: true, input_html: { class: "form-control" } %>
  </div>
  <div class="col-sm-2">
    <%= form.input :quantity, required: true, input_html: { class: "form-control" } %>
  </div>
  <div class="col-sm-2">
    <%= form.input :price, required: true, input_html: { class: "form-control" } %>
  </div>
  <div class="col-sm-2">
  <%= form.label :discount, "Descuento (%)", class: "form-label" %>
  <div class="input-group">
    <%= form.number_field :discount, min: 0, max: 100, step: 1, class: "form-control" %>
    <span class="input-group-text">%</span>
  </div>
</div>

</div>

<div class="row mb-3">
  <div class="col">
    <%= form.input :description, as: :text, required: true, input_html: { class: "form-control", rows: 2 } %>
  </div>
</div>

<div class="row mb-3">
  <div class="col">
    <%= form.input :category_id,
      collection: Category.all.map { |c| [c.name, c.id] },
      include_blank: "Selecciona una categoría",
      input_html: { class: "form-select" } %>
  </div>
</div>

<!-- Imágenes múltiples -->
<h5 class="mt-4">Imágenes del producto</h5>
<div id="product-images-container">
  <%= form.simple_fields_for :product_images do |img_form| %>
    <div class="row mb-2 image-item">
      <div class="col-sm-4">
        <%= img_form.input :title, input_html: { class: "form-control" } %>
      </div>
      <div class="col-sm-4">
        <%= img_form.input :image_url, input_html: { class: "form-control" } %>
        <% if img_form.object.image_url.present? %>
          <%= image_tag(img_form.object.image_url, class: "img-fluid mt-1", style: "max-height:100px; object-fit:cover;") %>
        <% end %>
      </div>
      <div class="col-sm-2">
        <%= img_form.input :image_index, 
              as: :integer,
              error: false,
              input_html: { 
                class: "form-control", 
                min: 0, 
                step: 1, 
                oninput: "this.value=this.value.replace(/[^0-9]/g,'');" 
              } %>
      </div>
      <div class="col-sm-2 d-flex align-items-end">
        <%= img_form.hidden_field :_destroy %>
        <button type="button" class="btn btn-danger btn-sm remove-image">Eliminar</button>
      </div>
    </div>
  <% end %>
</div>

<button type="button" class="btn btn-secondary btn-sm mb-3" id="add-image">Agregar Imagen</button>

<!-- Script para agregar/eliminar imágenes dinámicamente -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const container = document.getElementById("product-images-container");
  const addBtn = document.getElementById("add-image");

  addBtn.addEventListener("click", function() {
    const index = container.querySelectorAll(".image-item").length;
    const newItem = document.createElement("div");
    newItem.classList.add("row", "mb-2", "image-item");
    newItem.innerHTML = `
      <div class="col-sm-4">
        <input class="form-control" name="product[product_images_attributes][${index}][title]" type="text" placeholder="Título de la imagen">
      </div>
      <div class="col-sm-4">
        <input class="form-control" name="product[product_images_attributes][${index}][image_url]" type="text" placeholder="URL de la imagen">
      </div>
      <div class="col-sm-2">
        <input class="form-control" name="product[product_images_attributes][${index}][image_index]" type="number" placeholder="Orden">
      </div>
      <div class="col-sm-2 d-flex align-items-end">
        <input type="hidden" name="product[product_images_attributes][${index}][_destroy]" value="false">
        <button type="button" class="btn btn-danger btn-sm remove-image">Eliminar</button>
      </div>
    `;
    container.appendChild(newItem);
  });

  container.addEventListener("click", function(e) {
    if(e.target && e.target.classList.contains("remove-image")) {
      const row = e.target.closest(".image-item");
      const destroyInput = row.querySelector('input[type="hidden"][name*="_destroy"]');
      if(destroyInput) {
        destroyInput.value = "1";
        row.style.display = "none";
      } else {
        row.remove();
      }
    }
  });
});
</script>
