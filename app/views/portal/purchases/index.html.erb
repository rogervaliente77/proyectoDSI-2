<div class="container py-5 bg-light min-vh-100">
  <h2 class="mb-4 text-center fw-bold text-uppercase">Mis compras</h2>

  <% if @purchases.empty? %>
    <div class="text-center py-5">
      <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">A√∫n no has realizado ninguna compra</h5>
      <%= link_to "Ver productos", portal_home_path, class: "btn btn-primary mt-3" %>
    </div>
  <% else %>
    <% @purchases.each do |sale| %>
      <div class="card mb-4 shadow-sm border-0 rounded-4 p-3">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <strong class="fs-6">C√≥digo: <%= sale.code %></strong><br>
            <small class="text-muted">Realizada el <%= l(sale.sold_at, format: :long) %></small>
          </div>
        </div>

        <% sale.product_sales.each do |ps| %>
          <div class="d-flex align-items-center border-top pt-3 mt-2">
            <!-- Imagen del producto -->
            <% image_url = ps.product&.product_images&.first&.image_url || "placeholder.png" %>
            <%= image_tag image_url, class: "rounded me-4", style: "width: 100px; height: 100px; object-fit: cover;" %>

            <!-- Detalles del producto -->
            <div class="flex-grow-1">
              <strong><%= ps.product&.name || "Producto eliminado" %></strong><br>
              <span class="text-muted">Cantidad:</span> <%= ps.quantity %><br>
              <span class="text-success fw-bold">$<%= '%.2f' % ps.subtotal %></span>
            </div>
          </div>
        <% end %>

        <div class="mt-3">
          <p class="mb-1">
            <strong>M√©todo de env√≠o:</strong>
            <% if sale&.delivery_method == "delivery" %>
              Entrega a domicilio
            <% else %>
              Recoger en tienda
            <% end %>
          </p>

          <% if sale.delivery_method == "delivery" %>
            <% if !sale&.delivery&.delivered_at&.present? %>
              <span class="badge bg-warning text-dark">No entregado</span>
              <% if sale.delivery.present? %>
                <% if sale.delivery.delivery_status == 'unassigned' %>
                                <span class="badge badge-secondary">No asignado</span>
                            <% elsif sale.delivery.delivery_status == 'assigned' %>
                                <span class="badge badge-info">Asignado</span>
                            <% elsif sale.delivery.delivery_status == 'picked_up' %>
                                <span class="badge badge-info">Recogido</span>
                            <% elsif sale.delivery.delivery_status == 'in_route' %>
                                <span class="badge badge-warning">En camino</span>
                            <% elsif sale.delivery.delivery_status == 'onsite' %>
                                <span class="badge badge-dark">En el lugar</span>
                            <% elsif sale.delivery.delivery_status == 'delivered' %>
                                <span class="badge badge-success">Pedido entregado</span>
                            <% elsif sale.delivery.delivery_status == 'rejected' %>
                                <span class="badge badge-danger">Rechazado</span>
                            <% end %>
              <% else %>
                <span class="badge bg-secondary">Proceso de entrega no iniciado</span>
              <% end %>

              <% if !sale&.delivery&.has_appointment?%>
                <!-- üîπ Bot√≥n para agendar cita de entrega -->
                <div class="mt-2">
                  <%= link_to "Agendar entrega", 
                      portal_purchase_schedule_appointment_path(sale.id), 
                      class: "btn btn-primary btn-sm" %>
                </div>
              <% else %>

                  <%= link_to "Ver estado del pedido", 
                      portal_purchase_estado_entrega_path(purchase_id: sale.id), 
                      class: "btn btn-primary btn-sm", data: { turbo: false } %>
              <% end %>

            <% else %>
              <span class="badge badge-success">Pedido entregado</span>
              <%= link_to "Ver detalles del pedido", 
                      portal_purchase_estado_entrega_path(purchase_id: sale.id), 
                      class: "btn btn-primary btn-sm", data: { turbo: false } %>
              <br>        
              <strong>Hora de entrega: </strong>
              <p>
                <%= sale&.delivery.delivered_at.strftime("%d/%m/%Y %H:%M:%S") if sale&.delivery.delivered_at.present? %>
              </p>

              
            <% end %>
          <% end %>

          <p class="mb-1 text-muted mt-2">
            <small>El pago se realizar√° al recoger el producto.</small>
          </p>
        </div>

        <div class="d-flex justify-content-between align-items-center border-top mt-3 pt-3">
          <span class="fw-bold fs-5 text-success">Total: $<%= '%.2f' % sale.total_amount %></span>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
