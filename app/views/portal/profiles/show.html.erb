<div class="container mt-4">
  <h2 class="mb-4">Informaci√≥n del Perfil</h2>

  <%= form_with model: @user, url: portal_profile_path, method: :patch, local: true, multipart: true do |f| %>
    <div class="row mb-4">
      <!-- Imagen de perfil -->
      <div class="col-md-4 text-center">
       <% if @user.profile_image_url.present? %>
          <%= image_tag @user.profile_image_url, class: "img-thumbnail rounded-circle mb-3", style: "width: 120px; height: 120px; object-fit: cover;" %>
        <% else %>
          <%= image_tag "default-avatar.svg", class: "img-thumbnail rounded-circle mb-3", style: "width: 120px; height: 120px;" %>
        <% end %>

        <%= f.file_field :profile_image, class: "form-control" %>
      </div>

      <!-- Informaci√≥n b√°sica -->
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group mb-3">
              <%= f.label :first_name, "Nombre" %>
              <%= f.text_field :first_name, class: "form-control" %>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-group mb-3">
              <%= f.label :last_name, "Apellido" %>
              <%= f.text_field :last_name, class: "form-control" %>
            </div>
          </div>
        </div>

        <div class="form-group mb-3">
          <%= f.label :email, "Correo electr√≥nico" %>
          <%= f.text_field :email, class: "form-control", readonly: true %>
        </div>

        <div class="form-group mb-3">
          <%= f.label :phone_number, "N√∫mero de tel√©fono" %>
          <%= f.text_field :phone_number, class: "form-control" %>
        </div>
      </div>
    </div>

    <hr>

    <!-- ‚úÖ CONTENEDOR PARA DIRECCIONES -->

    <% if @current_user.role.name == "cliente" %>
      <h4>Direcciones</h4>

      <div id="addresses">
        <%= f.fields_for :addresses do |address_form| %>
          <div class="address-fields row mb-3 border rounded p-3 bg-light">
            <%= address_form.hidden_field :_destroy %>

            <!-- üè∑Ô∏è Campo nombre con select -->
            <div class="col-md-4">
              <%= address_form.label :name, "Nombre de la direcci√≥n" %>
              <%= address_form.text_field :name, class: "form-control", placeholder: "Ej: Casa, Trabajo, etc." %>
            </div>

            <div class="col-md-4">
              <%= address_form.label :department, "Departamento" %>
              <%= address_form.text_field :department, class: "form-control" %>
            </div>

            <div class="col-md-4">
              <%= address_form.label :municipality, "Municipio" %>
              <%= address_form.text_field :municipality, class: "form-control" %>
            </div>

            <div class="col-md-4">
              <%= address_form.label :street, "Calle/Avenida" %>
              <%= address_form.text_field :street, class: "form-control" %>
            </div>

            <div class="col-md-4 mt-2">
              <%= address_form.label :house, "Casa/Apartamento" %>
              <%= address_form.text_field :house, class: "form-control" %>
            </div>

            <div class="col-md-4 mt-2">
              <%= address_form.label :reference, "Referencia" %>
              <%= address_form.text_field :reference, class: "form-control" %>
            </div>
            
            <div class=" mt-4 text-end">
              <button type="button" 
                class="btn btn-danger remove-address" 
                data-id="<%= address_form.object.id %>">
                Eliminar
              </button>

            </div>


            <div class="col-md-4 mt-4 text-end">
            </div>
          </div>
        <% end %>
      </div>

      <div class="d-flex justify-content-center gap-2 mt-4">
        <%= link_to "Agregar direcci√≥n", "#", class: "btn btn-outline-primary", id: "add-address" %>
        
      </div>
    <% end %>
    <div class="d-flex justify-content-end gap-2 mt-4">
      <%= f.submit "Guardar cambios", class: "btn btn-success" %>
    </div>
  <% end %>
</div>

<!-- ‚úÖ CSS -->
<style>
  .fade-in {
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  .fade-in.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<!-- ‚úÖ JavaScript -->
<script>
document.addEventListener("turbo:load", () => {
  const addBtn = document.getElementById("add-address");
  const addressesDiv = document.getElementById("addresses");

  if (!addBtn || !addressesDiv) return;

  const maxAddresses = 3;

  const countActiveAddresses = () => {
    return addressesDiv.querySelectorAll('.address-fields:not([style*="display: none"])').length;
  };

  addBtn.addEventListener("click", (e) => {
    e.preventDefault();

    const currentCount = countActiveAddresses();
    if (currentCount >= maxAddresses) {
      alert("Solo puedes agregar hasta 3 direcciones.");
      return;
    }

    const index = currentCount;

    const wrapper = document.createElement("div");
    wrapper.classList.add("address-fields", "row", "mb-3", "border", "rounded", "p-3", "bg-light", "fade-in");

    wrapper.innerHTML = `
      <input type="hidden" name="user[addresses_attributes][${index}][_destroy]" value="false">

      <div class="col-md-4">
        <label>Nombre de la direcci√≥n</label>
        <input class="form-control" type="text" name="user[addresses_attributes][${index}][name]" placeholder="Ej: Casa, Trabajo, etc.">
      </div>

      <div class="col-md-4">
        <label>Departamento</label>
        <input class="form-control" type="text" name="user[addresses_attributes][${index}][department]">
      </div>

      <div class="col-md-4">
        <label>Municipio</label>
        <input class="form-control" type="text" name="user[addresses_attributes][${index}][municipality]">

        
      </div>

      <div class="col-md-4 mt-2">
        <label>Calle/Avenida</label>
        <input class="form-control" type="text" name="user[addresses_attributes][${index}][street]">
      </div>

      <div class="col-md-4 mt-2">
        <label>Casa/Apartamento</label>
        <input class="form-control" type="text" name="user[addresses_attributes][${index}][house]">
      </div>

      <div class="col-md-4 mt-2">
        <label>Referencia</label>
        <input class="form-control" type="text" name="user[addresses_attributes][${index}][reference]">

        <!-- üü¢ Bot√≥n eliminar debajo de la tercera columna -->
        <div class="text-end mt-2">
          <a href="#" class="btn btn-danger btn-sm remove-address">Eliminar</a>
        </div>
      </div>
    `;

    addressesDiv.appendChild(wrapper);

    requestAnimationFrame(() => {
      wrapper.classList.add("show");
    });
  });

  document.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('remove-address')) {
    e.preventDefault();

    const addressId = e.target.dataset.id;

    Swal.fire({
      title: '¬øEliminar direcci√≥n?',
      text: 'Esta acci√≥n no se puede deshacer.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'S√≠, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        // Si la direcci√≥n ya existe en la BD
        if (addressId) {
          fetch(`/portal/addresses/${addressId}`, {
            method: 'DELETE',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
              'Accept': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire('Eliminado', data.message, 'success');
              // Oculta visualmente el bloque eliminado
              const addressFields = e.target.closest('.address-fields');
              if (addressFields) addressFields.remove();
            } else {
              Swal.fire('Error', data.message, 'error');
            }
          })
          .catch(() => Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error'));
        } else {
          // Si la direcci√≥n es nueva (a√∫n no guardada)
          const addressFields = e.target.closest('.address-fields');
          if (addressFields) addressFields.remove();
        }
      }
    });
  }
});


});
</script>




