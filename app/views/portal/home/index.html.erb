<div class="container-fluid bg-light min-vh-100 py-5">

  <!-- Cabecera Profesional -->
  <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between mb-4 p-4 rounded" style="background-color: #cfe2ff; gap: 1.5rem;">
    
    <!-- Título y descripción -->
    <div class="flex-grow-1 text-center">
      <h1 class="h2 text-dark fw-bold mb-2">Catálogo de Productos</h1>
      <p class="text-muted mb-0 fs-6">Descubra nuestras mejores opciones y adquiera sus productos.</p>
    </div>

  </div>

  <% if flash[:notice] %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% elsif flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <!-- Filtros -->
  <div class="card p-4 mb-5 shadow-sm rounded">
    <%= form_with url: portal_home_path, method: :get, local: true, class: "row g-3 align-items-end" do %>

      <div class="col-md-3">
        <label class="form-label small text-secondary">Buscar por nombre</label>
        <%= text_field_tag :query, params[:query], placeholder: "Ej. Camiseta, Laptop...", class: "form-control form-control-md" %>
      </div>

      <div class="col-md-3">
        <label class="form-label small text-secondary">Categoría</label>
        <%= select_tag :category_id, options_from_collection_for_select(@categories || [], :id, :name, params[:category_id]), prompt: "Todas las categorías", class: "form-select form-select-md" %>
      </div>

      <div class="col-md-3">
        <label class="form-label small text-secondary">Marca</label>
        <%= select_tag :marca_id, options_from_collection_for_select(@marcas || [], :id, :name, params[:marca_id]), prompt: "Todas las marcas", class: "form-select form-select-md" %>
      </div>

      <div class="col-md-3">
        <label class="form-label small text-secondary">Precio ($)</label>
        <div class="d-flex gap-2 align-items-center">
          <input type="number" name="min_price" value="<%= params[:min_price] || 0 %>" class="form-control form-control-md" placeholder="Min" min="0" style="width: 90px;">
          <span class="text-muted">-</span>
          <input type="number" name="max_price" value="<%= params[:max_price] || 1000 %>" class="form-control form-control-md" placeholder="Max" min="0" style="width: 90px;">
        </div>
      </div>

      <div class="col-12 d-flex gap-3 mt-3">
        <%= submit_tag "Aplicar", class: "btn btn-primary btn-md flex-grow-1" %>
        <%= link_to portal_home_path, class: "btn btn-outline-secondary btn-md flex-grow-1" do %>
          Limpiar
        <% end %>
      </div>

    <% end %>
  </div>

  <!-- Productos -->
  <div class="row g-4">
    <% if @products.present? && @products.any? %>
      <% @products.each do |product| %>
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
          <div class="card border-0 shadow-sm rounded-lg h-100 product-card bg-white position-relative">

            <!-- Badge de disponibilidad -->
            <% if product.quantity.to_i > 0 %>
              <span class="badge bg-success small">Disponible</span>
            <% else %>
              <span class="badge bg-secondary small">Agotado</span>
            <% end %>

            <!-- Carrusel hover-driven -->
            <div class="custom-carousel">
              <% images = product.product_images.select { |img| img.image_url.present? }.sort_by(&:image_index) %>
              <% if images.any? %>
                <% images.each_with_index do |img, index| %>
                  <img src="<%= img.image_url %>" class="carousel-image <%= 'active' if index.zero? %>" alt="<%= product.name %> imagen <%= index+1 %>">
                <% end %>
                <button class="carousel-btn prev" onclick="prevSlide(this)">‹</button>
                <button class="carousel-btn next" onclick="nextSlide(this)">›</button>
              <% else %>
                <img src="https://via.placeholder.com/300x220" class="carousel-image active" alt="<%= product.name %>">
              <% end %>
            </div>

            <!-- Información del producto -->
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-dark fw-bold mb-2 fs-5"><%= product.name %></h5>
              <p class="card-text text-muted mb-2 fs-7"><%= truncate(product.description, length: 100) %></p>
              <p class="mt-auto mb-2 fs-5">
                <% if product.discount.to_i > 0 %>
                  <span class="text-muted text-decoration-line-through">
                    <%= number_to_currency(product.price) %>
                  </span>
                  <br>
                  <span class="fw-bold text-success fs-5">
                    <%= number_to_currency(product.discounted_price) %>
                  </span>
                  <span class="fw-bold text-success fs-5">
                    (-<%= product.discount %>%)
                  </span>
                <% else %>
                  <span class="fw-bold fs-5">
                    <%= number_to_currency(product.price) %>
                  </span>
                <% end %>
              </p>
              <p class="mb-0 fs-7"><strong>Categoría:</strong> <span class="text-muted"><%= product.category.name if product.category %></span></p>
            </div>

          </div>
        </div>
      <% end %>
    <% else %>
      <div class="col-12 text-center mt-5">
        <p class="text-muted fs-6">No se encontraron productos con los criterios de búsqueda.</p>
      </div>
    <% end %>
  </div>

</div>

<!-- Estilos y Scripts del carrusel -->
<style>
.custom-carousel { position: relative; width: 100%; height: 250px; overflow: hidden; border-radius: 10px; margin-bottom: 12px; }
.carousel-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.5s ease-in-out; z-index: 1; }
.carousel-image.active { opacity: 1; z-index: 2; }
.carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.5rem; border-radius: 50%; z-index: 10; transition: background 0.3s; }
.carousel-btn:hover { background: rgba(0,0,0,0.7); }
.carousel-btn.prev { left: 10px; }
.carousel-btn.next { right: 10px; }
.badge { position: absolute !important; top: 0.5rem; right: 0.5rem; z-index: 10; padding: 0.4rem 0.7rem; font-size: 0.85rem; }
</style>

<script>
function showSlide(carousel, index) {
  const slides = carousel.querySelectorAll('.carousel-image');
  slides.forEach((s, i) => s.classList.toggle('active', i === index));
  carousel.dataset.current = index;
}
function prevSlide(button) { const carousel = button.closest('.custom-carousel'); const slides = carousel.querySelectorAll('.carousel-image'); let index = parseInt(carousel.dataset.current || 0); index = (index - 1 + slides.length) % slides.length; showSlide(carousel, index); }
function nextSlide(button) { const carousel = button.closest('.custom-carousel'); const slides = carousel.querySelectorAll('.carousel-image'); let index = parseInt(carousel.dataset.current || 0); index = (index + 1) % slides.length; showSlide(carousel, index); }

document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.product-card').forEach(card => {
    let interval = null;
    const carousel = card.querySelector('.custom-carousel');
    if (!carousel) return;
    card.addEventListener('mouseenter', () => {
      let index = parseInt(carousel.dataset.current || 0);
      interval = setInterval(() => {
        const slides = carousel.querySelectorAll('.carousel-image');
        index = (index + 1) % slides.length;
        showSlide(carousel, index);
      }, 2000);
    });
    card.addEventListener('mouseleave', () => { clearInterval(interval); });
  });
});
</script>
