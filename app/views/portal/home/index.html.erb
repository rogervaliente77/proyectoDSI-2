<div class="container-fluid bg-light min-vh-100 py-5">

  <!-- Cabecera Profesional -->
  <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between mb-4 p-4 rounded" style="background-color: #cfe2ff; gap: 1.5rem;">
    <div class="flex-grow-1 text-center">
      <h1 class="h2 text-dark fw-bold mb-2">Cat√°logo de Productos</h1>
      <p class="text-muted mb-0 fs-6">Descubra nuestras mejores opciones y adquiera sus productos.</p>
    </div>
  </div>

  <% if flash[:notice] %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% elsif flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <!-- Filtros -->
  <div class="mb-3">
    <div class="container">
      <%= form_with url: portal_home_path, method: :get, local: true, class: "row row-cols-lg-auto g-2 align-items-end justify-content-start" do %>
        <div class="col">
          <label class="form-label small text-secondary">Buscar</label>
          <%= text_field_tag :query, params[:query], placeholder: "Ej. Taladro, Laptop...", class: "form-control form-control-sm" %>
        </div>
        <div class="col">
          <label class="form-label small text-secondary">Categor√≠a</label>
          <%= select_tag :category_id, options_from_collection_for_select(@categories || [], :id, :name, params[:category_id]), prompt: "Todas", class: "form-select form-select-sm" %>
        </div>
        <div class="col">
          <label class="form-label small text-secondary">Marca</label>
          <%= select_tag :marca_id, options_from_collection_for_select(@marcas || [], :id, :name, params[:marca_id]), prompt: "Todas", class: "form-select form-select-sm" %>
        </div>
        <div class="col">
          <label class="form-label small text-secondary">Oferta</label>
          <%= select_tag :offer, options_for_select([["Descuento","descuento"],["2x1","2x1"],["3x1","3x1"],["Mayoreo","mayoreo"]], params[:offer]), include_blank: "Seleccione...", class: "form-select form-select-sm" %>
        </div>
        <div class="col d-flex align-items-end gap-2">
          <%= submit_tag "Aplicar", class: "btn btn-primary btn-sm" %>
          <%= link_to "Reiniciar", portal_home_path, class: "btn btn-outline-secondary btn-sm" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Productos -->
  <div class="row g-3">
    <% if @products.any? %>
      <% @products.each do |product| %>
        <% images = product.product_images.map(&:image_url) %>
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
          <div class="card border-0 shadow-sm rounded-lg h-100 product-card bg-white position-relative">

            <!-- Badges -->
            <div class="position-absolute top-0 start-0 m-2 d-flex flex-column gap-1 zindex-10">
              <% if product.offer_type.present? %>
                <span class="badge bg-danger small text-uppercase"><%= product.offer_type %></span>
              <% end %>
              <% if product.quantity > 0 %>
                <span class="badge bg-success small">Disponible</span>
              <% else %>
                <span class="badge bg-secondary small">Agotado</span>
              <% end %>
            </div>

            <!-- Carrusel -->
            <div class="product-carousel" data-images="<%= images.join('|') %>">
              <img class="carousel-img" src="<%= images.first || 'https://via.placeholder.com/300x220?text=Sin+imagen' %>" alt="<%= product.name %>">
              <% if images.size > 1 %>
                <button class="carousel-btn prev-btn">&lt;</button>
                <button class="carousel-btn next-btn">&gt;</button>
              <% end %>
            </div>

            <!-- Informaci√≥n -->
            <div class="card-body d-flex flex-column p-3">
              <h6 class="card-title text-dark fw-bold text-truncate mb-1"><%= product.name %></h6>
              <p class="card-text text-muted small mb-2"><%= truncate(product.description, length: 60) %></p>

              <div class="mt-auto">
                <% if product.discount.to_i > 0 %>
                  <p class="mb-1 small text-muted text-decoration-line-through"><%= number_to_currency(product.price) %></p>
                  <p class="fw-bold text-success mb-2"><%= number_to_currency(product.discounted_price) %> (-<%= product.discount %>%)</p>
                <% else %>
                  <p class="fw-bold text-dark mb-2"><%= number_to_currency(product.price) %></p>
                <% end %>

                <% if product.quantity > 0 %>
                  <div class="d-flex gap-2 align-items-center">
                    <input type="number" value="1" min="1" class="form-control form-control-sm quantity-input" style="width:70px;">
                    <button class="btn btn-sm btn-primary add-to-cart-btn" 
                            data-product-id="<%= product.id %>" 
                            data-product-name="<%= product.name %>">
                      Agregar al carrito
                    </button>
                  </div>
                <% end %>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted"><%= product.category&.name %></small>
              </div>
            </div>

          </div>
        </div>
      <% end %>
    <% else %>
      <div class="col-12 text-center mt-4"><p class="text-muted">No se encontraron productos.</p></div>
    <% end %>
  </div>

  <!-- Offcanvas carrito -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="cartOffcanvasLabel">üõçÔ∏è Tu carrito</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body" id="cart-content">
      <%= render partial: "portal/carts/cart", locals: { cart: session[:cart] || [] } %>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1100;"></div>

  <!-- Carrito flotante abajo derecha -->
  <div class="position-fixed bottom-0 end-0 m-3" style="z-index:2000;">
    <button type="button" class="btn btn-primary position-relative btn-lg rounded-circle" 
            data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
      üõí
      <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        <%= (session[:cart] || []).sum { |item| item["quantity"] } %>
      </span>
    </button>
  </div>

</div>

<!-- TOASTS DE OFERTAS -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;">
  <% @products.select(&:on_offer?).each do |product| %>
    <div class="toast align-items-center text-white bg-primary border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          üéâ <strong><%= product.name %></strong> en <strong><%= product.offer_type || "Oferta" %></strong>  
          - Precio: <%= number_to_currency(product.discounted_price || product.price) %>
          <% if product.discount.to_i > 0 %>
            (-<%= product.discount %>%)
          <% end %>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Cerrar"></button>
      </div>
    </div>
  <% end %>
</div>

<style>
.product-carousel { position: relative; width: 100%; height: 250px; overflow: hidden; }
.carousel-img { width: 100%; height: 100%; object-fit: contain; }
.carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); border:none; background:rgba(0,0,0,0.3); color:#fff; font-weight:bold; padding:0.3rem 0.6rem; cursor:pointer; border-radius:3px; z-index:5; }
.prev-btn { left:5px; } .next-btn { right:5px; }
.card-title { font-size:0.95rem; }
.card-text { font-size:0.8rem; line-height:1.3; }
.badge.small { font-size:0.7rem; padding:0.25rem 0.4rem; cursor:pointer; z-index:10; position:relative; }
.quantity-input { width:70px; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // Carrusel
  document.querySelectorAll('.product-carousel').forEach(carousel => {
    const imgEl = carousel.querySelector('.carousel-img');
    const nextBtn = carousel.querySelector('.next-btn');
    const prevBtn = carousel.querySelector('.prev-btn');
    const images = carousel.dataset.images.split('|');
    let index = 0;
    let interval;

    const showImage = i => imgEl.src = images[i];
    if(nextBtn) nextBtn.addEventListener('click', e => { e.stopPropagation(); index=(index+1)%images.length; showImage(index); });
    if(prevBtn) prevBtn.addEventListener('click', e => { e.stopPropagation(); index=(index-1+images.length)%images.length; showImage(index); });

    carousel.addEventListener('mouseenter', () => { if(images.length>1) interval=setInterval(()=>{ index=(index+1)%images.length; showImage(index); },1500); });
    carousel.addEventListener('mouseleave', () => clearInterval(interval));
  });

  // Funci√≥n Toast
  function showToast(message, type='success'){
    const container = document.getElementById('toast-container');
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
    toastEl.setAttribute('role','alert');
    toastEl.setAttribute('aria-live','assertive');
    toastEl.setAttribute('aria-atomic','true');
    toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Cerrar"></button></div>`;
    container.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, {autohide:true, delay:3000});
    toast.show();
    toastEl.querySelector('.btn-close').addEventListener('click', ()=>toast.hide());
  }

  // Agregar al carrito
  document.addEventListener("click", function(e){
    if(e.target.classList.contains("add-to-cart-btn")){
      const btn = e.target;
      const qtyInput = btn.closest('div').querySelector('.quantity-input');
      const quantity = parseInt(qtyInput.value) || 1;

      fetch(`/portal/cart/add/${btn.dataset.productId}`,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({quantity})
      }).then(r=>r.json()).then(data=>{
        if(data.success){
          showToast(`‚úÖ ${btn.dataset.productName} agregado al carrito (${quantity})`);

          // Actualizar contador carrito
          const cartCountEl = document.getElementById('cart-count');
          let cartCount = parseInt(cartCountEl.innerText)||0;
          cartCount += quantity;
          cartCountEl.innerText = cartCount;

          // actualizar offcanvas si est√° abierto
          const offcanvas = document.querySelector(".offcanvas.show");
          if(offcanvas){
            fetch("/portal/cart").then(r=>r.text()).then(html=>document.getElementById("cart-content").innerHTML=html);
          }
        } else {
          showToast(`‚ö†Ô∏è ${data.error || "No se pudo agregar el producto"}`, 'danger');
        }
      });
    }

    // Botones del carrito (+, -, eliminar)
    const cartBtn = e.target.closest(".cart-btn");
    if(cartBtn){
      const productId = cartBtn.dataset.id;
      const action = cartBtn.dataset.action;
      if(!productId || !action) return;
      let url = `/portal/cart/${action}/${productId}`;
      let method = action==="remove"?"DELETE":"POST";
      fetch(url,{method, headers:{"X-CSRF-Token":document.querySelector('meta[name="csrf-token"]').getAttribute('content')}})
        .then(r=>r.text())
        .then(html=>document.getElementById("cart-content").innerHTML=html)
        .catch(err=>console.error(err));
      if(action==="remove") showToast("üóëÔ∏è Producto eliminado del carrito","danger");
    }
  });

  // Inicializar toasts de ofertas
  document.querySelectorAll('.toast').forEach(function(toastEl){
    const toast = new bootstrap.Toast(toastEl, {autohide:false});
    toast.show();
    toastEl.querySelector('.btn-close').addEventListener('click', ()=>toast.hide());
  });

  // Cargar carrito al abrir offcanvas
  const cartOffcanvas = document.getElementById("cartOffcanvas");
  if(cartOffcanvas){
    cartOffcanvas.addEventListener("show.bs.offcanvas",()=>{
      fetch("/portal/cart").then(r=>r.text()).then(html=>document.getElementById("cart-content").innerHTML=html)
        .catch(()=>document.getElementById("cart-content").innerHTML="<p>Error al cargar el carrito.</p>");
    });
  }

});
</script>
