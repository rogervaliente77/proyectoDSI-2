<div class="container-fluid bg-light min-vh-100 py-5">

  <!-- Cabecera Profesional -->
  <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between mb-4 p-4 rounded" style="background-color: #cfe2ff; gap: 1.5rem;">
    <div class="flex-grow-1 text-center">
      <h1 class="h2 text-dark fw-bold mb-2">Cat√°logo de Productos</h1>
      <p class="text-muted mb-0 fs-6">Descubra nuestras mejores opciones y adquiera sus productos.</p>
    </div>
  </div>

  <% if flash[:notice] %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% elsif flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <!-- Filtros -->
  <div class="card p-4 mb-5 shadow-sm rounded">
    <%= form_with url: portal_home_path, method: :get, local: true, class: "row g-3 align-items-end" do %>
      <div class="col-md-3">
        <label class="form-label small text-secondary">Buscar por nombre</label>
        <%= text_field_tag :query, params[:query], placeholder: "Ej. Camiseta, Laptop...", class: "form-control form-control-md" %>
      </div>
      <div class="col-md-3">
        <label class="form-label small text-secondary">Categor√≠a</label>
        <%= select_tag :category_id, options_from_collection_for_select(@categories || [], :id, :name, params[:category_id]), prompt: "Todas las categor√≠as", class: "form-select form-select-md" %>
      </div>
      <div class="col-md-3">
        <label class="form-label small text-secondary">Marca</label>
        <%= select_tag :marca_id, options_from_collection_for_select(@marcas || [], :id, :name, params[:marca_id]), prompt: "Todas las marcas", class: "form-select form-select-md" %>
      </div>
      <div class="col-md-3">
        <label class="form-label small text-secondary">Precio ($)</label>
        <div class="d-flex gap-2 align-items-center">
          <input type="number" name="min_price" value="<%= params[:min_price] || 0 %>" class="form-control form-control-md" placeholder="Min" min="0" style="width: 90px;">
          <span class="text-muted">-</span>
          <input type="number" name="max_price" value="<%= params[:max_price] || 1000 %>" class="form-control form-control-md" placeholder="Max" min="0" style="width: 90px;">
        </div>
      </div>
      <div class="col-12 d-flex gap-3 mt-3">
        <%= submit_tag "Aplicar", class: "btn btn-primary btn-md flex-grow-1" %>
        <%= link_to portal_home_path, class: "btn btn-outline-secondary btn-md flex-grow-1" do %>
          Limpiar
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Productos -->
  <div class="row g-4">
    <% if @products.present? && @products.any? %>
      <% @products.each do |product| %>
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
          <div class="card border-0 shadow-sm rounded-lg h-100 product-card bg-white position-relative">

            <!-- Badge de Oferta -->
            <% if product.discount.to_i > 0 || product.offer_type.present? %>
              <span class="badge bg-warning text-dark position-absolute top-0 start-0 m-2">
                <i class="fas fa-gift me-1"></i> Oferta 
                <%= " #{product.offer_type.capitalize}" if product.offer_type.present? %>
              </span>
            <% end %>


            <!-- Badge de disponibilidad -->
            <% if product.quantity.to_i > 0 %>
              <span class="badge bg-success small position-absolute top-0 end-0 m-2">Disponible</span>
            <% else %>
              <span class="badge bg-secondary small position-absolute top-0 end-0 m-2">Agotado</span>
            <% end %>

            <!-- Carrusel hover-driven -->
            <div class="custom-carousel">
              <% images = product.product_images.select { |img| img.image_url.present? }.sort_by(&:image_index) %>
              <% if images.any? %>
                <% images.each_with_index do |img, index| %>
                  <img src="<%= img.image_url %>" class="carousel-image <%= 'active' if index.zero? %>" alt="<%= product.name %> imagen <%= index+1 %>">
                <% end %>
                <button class="carousel-btn prev" onclick="prevSlide(this)">‚Äπ</button>
                <button class="carousel-btn next" onclick="nextSlide(this)">‚Ä∫</button>
              <% else %>
                <img src="https://via.placeholder.com/300x220" class="carousel-image active" alt="<%= product.name %>">
              <% end %>
            </div>

            <!-- Informaci√≥n del producto -->
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-dark fw-bold mb-2 fs-5"><%= product.name %></h5>
              <p class="card-text text-muted mb-2 fs-7"><%= truncate(product.description, length: 100) %></p>
              <p class="mt-auto mb-2 fs-5">
                <% if product.discount.to_i > 0 %>
                  <%if product.offer_type == "descuento"%>
                    <span class="text-muted text-decoration-line-through">
                      <%= number_to_currency(product.price) %>
                    </span>
                    <br>
                    <span class="fw-bold text-success fs-5">
                      <%= number_to_currency(product.discounted_price) %>
                    </span>
                    <span class="fw-bold text-success fs-5">
                      (-<%= product.discount %>%)
                    </span>
                  <%elsif product.offer_type == "mayoreo"%>
                    <p class="mb-0 fs-7 text-primary"><strong>Obten precio de mayoreo a partir de <%= product.wholesale_quantity %></strong></p>
                    <br>
                    <span class="fw-bold text-success fs-5">
                      <%= number_to_currency(product.discounted_price) %> (-<%= product.discount %>%)
                    </span>
                    <span class="fw-bold fs-5">
                      Precio normal <%= number_to_currency(product.price) %>
                    </span>
                  <%end %>
                  <span class="fw-bold fs-5">
                    <%= number_to_currency(product.price) %>
                  </span>
                <% else %>
                  <span class="fw-bold fs-5">
                    <%= number_to_currency(product.price) %>
                  </span>
                  
                <% end %>
              </p>
              <p class="mb-0 fs-7"><strong>Categor√≠a:</strong> <span class="text-muted"><%= product.category.name if product.category %></span></p>
              <p class="mb-0 fs-7"><strong>Marca:</strong> <span class="text-muted"><%= product.marca.name if product.marca %></span></p>


                <div class="d-flex align-items-center">
                    <input type="number" name="quantity" value="1" min="1" 
                          class="form-control me-2 quantity-input" style="width: 80px;">
                    
                    <button type="button" class="btn btn-success add-to-cart-btn" 
                            data-product-id="<%= product.id %>" 
                            data-product-name="<%= product.name %>">
                      Agregar al carrito
                    </button>
                </div>
            </div>

          </div>
        </div>
      <% end %>
    <% else %>
      <div class="col-12 text-center mt-5">
        <p class="text-muted fs-6">No se encontraron productos con los criterios de b√∫squeda.</p>
      </div>
    <% end %>
  </div>

  <button class="btn btn-primary btn-lg rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; z-index: 1000;"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#cartOffcanvas"
        aria-controls="cartOffcanvas">
  üõí
  </button>

  
<!-- üõí Panel lateral del carrito -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="cartOffcanvasLabel">üõçÔ∏è Tu carrito</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body">
    <div id="cart-content">
      <%= render partial: "portal/carts/cart", locals: { cart: session[:cart] || [] } %>
    </div>
  </div>
</div>


<!-- Contenedor para toasts -->
<div id="toast-container" aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>

</div>

<!-- Toasts de ofertas con tipo y precio -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;">
  <% @products.select(&:on_offer?).each do |product| %>
    <div class="toast align-items-center text-white bg-primary border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          üéâ <strong><%= product.name %></strong> en <strong><%= product.offer_type || "Oferta" %></strong>  
          - Precio: <%= number_to_currency(product.discounted_price || product.price) %>
          <% if product.discount.to_i > 0 %>
            (-<%= product.discount %>%)
          <% end %>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Cerrar"></button>
      </div>
    </div>
  <% end %>
</div>

<style>
.custom-carousel { position: relative; width: 100%; height: 250px; overflow: hidden; border-radius: 10px; margin-bottom: 12px; }
.carousel-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.5s ease-in-out; z-index: 1; }
.carousel-image.active { opacity: 1; z-index: 2; }
.carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.5rem; border-radius: 50%; z-index: 10; transition: background 0.3s; }
.carousel-btn:hover { background: rgba(0,0,0,0.7); }
.carousel-btn.prev { left: 10px; }
.carousel-btn.next { right: 10px; }
.badge { padding: 0.4rem 0.7rem; font-size: 0.85rem; z-index: 10; }
</style>

<script>
// ==========================
// üé† Carousel (sin cambios)
// ==========================
function showSlide(carousel, index) {
  const slides = carousel.querySelectorAll('.carousel-image');
  slides.forEach((s, i) => s.classList.toggle('active', i === index));
  carousel.dataset.current = index;
}
function prevSlide(button) {
  const carousel = button.closest('.custom-carousel');
  const slides = carousel.querySelectorAll('.carousel-image');
  let index = parseInt(carousel.dataset.current || 0);
  index = (index - 1 + slides.length) % slides.length;
  showSlide(carousel, index);
}
function nextSlide(button) {
  const carousel = button.closest('.custom-carousel');
  const slides = carousel.querySelectorAll('.carousel-image');
  let index = parseInt(carousel.dataset.current || 0);
  index = (index + 1) % slides.length;
  showSlide(carousel, index);
}

document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.product-card').forEach(card => {
    let interval = null;
    const carousel = card.querySelector('.custom-carousel');
    if (!carousel) return;
    card.addEventListener('mouseenter', () => {
      let index = parseInt(carousel.dataset.current || 0);
      interval = setInterval(() => {
        const slides = carousel.querySelectorAll('.carousel-image');
        index = (index + 1) % slides.length;
        showSlide(carousel, index);
      }, 2000);
    });
    card.addEventListener('mouseleave', () => { clearInterval(interval); });
  });

  // Inicializar toasts
  document.querySelectorAll('.toast').forEach(function(toastEl) {
    const toast = new bootstrap.Toast(toastEl, { autohide: false });
    toast.show();
    toastEl.querySelector('.btn-close').addEventListener('click', function() { toast.hide(); });
  });
});


// ==========================
// üõí AGREGAR PRODUCTO
// ==========================
document.addEventListener("click", function(e) {
  if (e.target.classList.contains("add-to-cart-btn")) {
    const btn = e.target;
    const productId = btn.dataset.productId;
    const productName = btn.dataset.productName;
    const quantity = btn.closest('div').querySelector('.quantity-input')?.value || 1;

    fetch(`/portal/cart/add/${productId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({ quantity: quantity })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast(`‚úÖ ${productName} se agreg√≥ al carrito`, 'success');

        // üîÑ Si el carrito est√° abierto, recargar su contenido
        const offcanvas = document.querySelector(".offcanvas.show");
        if (offcanvas) {
          fetch("/portal/cart")
            .then(r => r.text())
            .then(html => document.getElementById("cart-content").innerHTML = html);
        }
      } else {
        showToast(`‚ö†Ô∏è ${data.error || "No se pudo agregar el producto"}`, 'danger');
      }
    });
  }
});


// ==========================
// üîî TOAST DE NOTIFICACI√ìN
// ==========================
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toastEl = document.createElement('div');
  toastEl.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
  toastEl.setAttribute('role', 'alert');
  toastEl.setAttribute('aria-live', 'assertive');
  toastEl.setAttribute('aria-atomic', 'true');

  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Cerrar"></button>
    </div>
  `;

  container.appendChild(toastEl);
  const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
  toast.show();

  toastEl.querySelector('.btn-close').addEventListener('click', () => toast.hide());
}


// ==========================
// üß© CARGAR CARRITO AL ABRIR
// ==========================
document.addEventListener("DOMContentLoaded", () => {
  const cartOffcanvas = document.getElementById("cartOffcanvas");
  if (cartOffcanvas) {
    cartOffcanvas.addEventListener("show.bs.offcanvas", () => {
      fetch("/portal/cart")
        .then(response => response.text())
        .then(html => {
          document.getElementById("cart-content").innerHTML = html;
        })
        .catch(() => {
          document.getElementById("cart-content").innerHTML = "<p>Error al cargar el carrito.</p>";
        });
    });
  }
});


// ==========================
// ‚öôÔ∏è BOTONES DEL CARRITO
// ==========================
document.addEventListener("DOMContentLoaded", function() {

  function updateCartHTML(html) {
    document.getElementById("cart-content").innerHTML = html;
  }

  // Escucha los botones +, ‚àí y üóëÔ∏è dentro del carrito
  document.addEventListener("click", function(e) {
    const btn = e.target.closest(".cart-btn");
    if (!btn) return;

    const productId = btn.dataset.id;
    const action = btn.dataset.action;

    if (!productId || !action) return;

    let url = `/portal/cart/${action}/${productId}`;
    let method = "POST";

    if (action === "remove") {
      method = "DELETE";
    }

    fetch(url, {
      method: method,
      headers: {
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(resp => resp.text())
    .then(html => updateCartHTML(html))
    .catch(err => console.error("Error actualizando carrito:", err));

    if (action === "remove") {
      showToast("üóëÔ∏è Producto eliminado del carrito", "danger");
    }
  });
});
</script>
