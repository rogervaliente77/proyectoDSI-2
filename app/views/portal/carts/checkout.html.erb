<div class="container-fluid bg-light min-vh-100 py-5">
  <div class="container my-5">
    <h2 class="mb-4 text-center">Finalizar compra</h2>

    <div class="row g-4">
      <!-- Columna izquierda: listado de productos -->
      <div class="col-lg-8 col-md-7">
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Productos en tu carrito</h5>
          <% @cart_items.each do |item| %>
            <div class="d-flex align-items-center mb-3 border-bottom pb-2">
              <% if item[:product].product_images.any? %>
                <%= image_tag item[:product].product_images.first.image_url, class: "img-thumbnail me-3", style: "width: 120px; height: 120px;" %>
              <% else %>
                <%= image_tag "placeholder.png", class: "img-thumbnail me-3", style: "width: 120px; height: 120px;" %>
              <% end %>
              <div class="flex-grow-1">
                <strong class="fs-5"><%= item[:product].name %></strong><br>
                Cantidad: <span class="fw-semibold"><%= item[:quantity] %></span><br>
                <span class="text-success fw-bold fs-6">$<%= '%.2f' % item[:subtotal] %></span>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Columna derecha: método de envío + resumen de compra -->
      <div class="col-lg-4 col-md-5">
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Método de envío</h5>

          <!-- Recoger en tienda -->
          <div class="p-2 border rounded text-center mb-2">
            <input type="radio" name="shipping" id="pickup" value="pickup" hidden checked>
            <label for="pickup" class="mb-0 fw-medium cursor-pointer">Recoger en tienda</label>
          </div>
          <p class="text-muted mt-2">El pago se realizará al momento de recoger el producto.</p>

          <!-- Selección de tienda -->
          <div class="mb-3">
            <select class="form-select">
              <option value="">Selecciona tienda</option>
              <option value="san_salvador">San Salvador</option>
              <option value="santa_ana">Santa Ana</option>
            </select>
          </div>
        </div>

        <!-- Resumen de compra -->
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Resumen de compra</h5>
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <span>$<%= '%.2f' % @subtotal %></span>
          </div>
          <hr>

          <!-- 🎟️ Cupón --> 
          <div class="mb-3"> 
            <label for="coupon" class="form-label fw-medium">¿Tienes un cupón?</label>
            <div class="input-group"> <input type="text" id="coupon" class="form-control" placeholder="Ingresa tu código"> 
                <button class="btn btn-outline-primary">Aplicar</button> 
            </div> 
          </div>
          
          <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
            <span>Total:</span>
            <span class="text-success">$<%= '%.2f' % @total %></span>
          </div>

          <%= form_with url: portal_create_purchase_portal_carts_path, method: :post, local: true do %>
            <div class="mt-4 text-center">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-circle"></i> Confirmar compra
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", () => {
    const homeOption = document.getElementById('home-option');
    const pickupOption = document.getElementById('pickup-option');
    const homeFields = document.getElementById('home-fields');
    const pickupFields = document.getElementById('pickup-fields');

    function selectShipping(option) {
      if(option === 'home') {
        // Animación slide down
        pickupFields.style.display = 'none';
        homeFields.style.display = 'block';
        homeFields.style.maxHeight = '1000px';
        homeOption.classList.add('border-success', 'bg-light');
        pickupOption.classList.remove('border-success', 'bg-light');
        document.getElementById('home').checked = true;
      } else {
        homeFields.style.display = 'none';
        pickupFields.style.display = 'block';
        pickupFields.style.maxHeight = '500px';
        pickupOption.classList.add('border-success', 'bg-light');
        homeOption.classList.remove('border-success', 'bg-light');
        document.getElementById('pickup').checked = true;
      }
    }

    // Inicializar estado según radio seleccionado
    const initialOption = document.getElementById('home').checked ? 'home' : 'pickup';
    selectShipping(initialOption);

    // Eventos de click
    homeOption.addEventListener('click', () => selectShipping('home'));
    pickupOption.addEventListener('click', () => selectShipping('pickup'));
  });
</script>

<style>
  .shipping-option {
    cursor: pointer;
    transition: 0.2s;
  }
  .shipping-option:hover {
    background-color: #f8f9fa;
  }
  .shipping-option.border-success {
    border-width: 2px !important;
  }
</style>
