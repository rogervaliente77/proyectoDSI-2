<div class="container-fluid bg-light min-vh-100 py-5">
  <div class="container my-5">
    <h2 class="mb-4 text-center">Finalizar compra</h2>

    <div class="row g-4">
      <!-- Columna izquierda: listado de productos -->
      <div class="col-lg-8 col-md-7">
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Productos en tu carrito</h5>

          <% @cart_items.each do |item| %>
            <% product = item[:product] %>
            <% quantity = item[:quantity] %>
            <% discounted_price = item[:unit_price] %>

            <div class="d-flex align-items-center mb-3 border-bottom pb-2 product-card" 
                 data-product-id="<%= product.id %>" 
                 data-price="<%= discounted_price %>" 
                 data-original-price="<%= product.price %>">

              <% if product.product_images.any? %>
                <%= image_tag product.product_images.first.image_url, class: "img-thumbnail me-3", style: "width: 120px; height: 120px;" %>
              <% else %>
                <%= image_tag "placeholder.png", class: "img-thumbnail me-3", style: "width: 120px; height: 120px;" %>
              <% end %>

              <div class="flex-grow-1 d-flex justify-content-between align-items-center">
                <div>
                  <strong class="fs-5"><%= product.name %></strong><br>

                  <div>
                    <i>Precio por unidad:</i>
                    <% if discounted_price < product.price %>
                      <span class="text-muted text-decoration-line-through">$<%= '%.2f' % product.price %></span>
                      <span class="badge bg-danger ms-2">-<%= '%.0f' % ((1 - discounted_price / product.price) * 100) %>%</span><br>
                    <% else %>
                      <span class="text-muted text-decoration-line-through d-none">$<%= '%.2f' % product.price %></span>
                      <span class="badge bg-danger ms-2"></span><br>
                    <% end %>
                    <span class="text-success fw-bold fs-5 price-per-unit">$<%= '%.2f' % discounted_price %></span>
                  </div>

                  <div class="mt-2">
                    <strong>Subtotal:</strong>
                    <span class="text-success subtotal">$<%= '%.2f' % (discounted_price * quantity) %></span>
                  </div>

                  <!-- Campo de cupón -->
                  <div class="input-group mt-2" style="max-width: 220px;">
                    <input type="text" class="form-control form-control-sm product-coupon" placeholder="Código de descuento">
                    <button class="btn btn-sm btn-outline-primary apply-coupon-btn" data-product-id="<%= product.id %>">Aplicar</button>
                  </div>
                </div>

                <div class="d-flex flex-column align-items-end">
                  <span class="fw-bold">Cantidad: <span class="quantity"><%= quantity %></span></span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Columna derecha -->
      <div class="col-lg-4 col-md-5">
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Método de envío</h5>
          <div class="p-2 border rounded text-center mb-2">
            <input type="radio" name="shipping" id="pickup" value="pickup" hidden checked>
            <label for="pickup" class="mb-0 fw-medium cursor-pointer">Recoger en tienda</label>
          </div>
          <p class="text-muted mt-2">El pago se realizará al momento de recoger el producto.</p>
          <div class="mb-3">
            <select class="form-select">
              <option value="">Selecciona tienda</option>
              <option value="san_salvador">San Salvador</option>
              <option value="santa_ana">Santa Ana</option>
            </select>
          </div>
        </div>

        <!-- Resumen de compra -->
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Resumen de compra</h5>

          <div class="d-flex justify-content-between mb-1">
            <span>Subtotal:</span>
            <span id="subtotal-amount">$<%= '%.2f' % @subtotal %></span>
          </div>

          <div class="d-flex justify-content-between text-danger mb-1">
            <span>Descuentos aplicados:</span>
            <span id="discount-amount">- $<%= '%.2f' % (@cart_items.sum { |item| item[:product].price * item[:quantity] } - @subtotal) %></span>
          </div>

          <hr>

          <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
            <span>Total a pagar:</span>
            <span id="total-amount" class="text-success">$<%= '%.2f' % @total %></span>
          </div>

          <%= form_with url: portal_checkout_path, method: :post, local: false, id: "checkout-form", data: { turbo: false } do |f| %>
            <div class="mt-4 text-center">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-circle"></i> Confirmar compra
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="coupon-toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-body">Cupón aplicado</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const productCards = document.querySelectorAll(".product-card");
  const subtotalDisplay = document.getElementById("subtotal-amount");
  const discountDisplay = document.getElementById("discount-amount");
  const totalDisplay = document.getElementById("total-amount");

  const cartData = {};
  const toastEl = document.getElementById("coupon-toast");
  const toastBody = document.getElementById("toast-body");
  const toast = new bootstrap.Toast(toastEl, { delay: 3000 });

  productCards.forEach(card => {
    const pid = card.dataset.productId;
    const quantityEl = card.querySelector(".quantity");
    const priceEl = card.querySelector(".price-per-unit");
    const originalPrice = parseFloat(card.dataset.originalPrice);

    cartData[pid] = {
      quantity: parseInt(quantityEl.textContent),
      price: parseFloat(priceEl.textContent.replace('$','')),
      originalPrice: originalPrice
    };
  });

  const updateTotals = () => {
    let subtotal = 0;
    let totalDiscount = 0;

    productCards.forEach(card => {
      const pid = card.dataset.productId;
      const qty = cartData[pid].quantity;
      const price = cartData[pid].price;
      const originalPrice = cartData[pid].originalPrice;

      const subtotalProduct = price * qty;
      subtotal += subtotalProduct;
      totalDiscount += (originalPrice - price) * qty;

      card.querySelector(".subtotal").textContent = `$${subtotalProduct.toFixed(2)}`;
      card.querySelector(".price-per-unit").textContent = `$${price.toFixed(2)}`;

      // Actualiza badge y precio tachado
      let badgeEl = card.querySelector(".badge");
      const textMutedEl = card.querySelector("span.text-muted");
      if (!badgeEl) {
        badgeEl = document.createElement("span");
        badgeEl.classList.add("badge","bg-danger","ms-2");
        card.querySelector(".price-per-unit").parentNode.insertBefore(badgeEl, card.querySelector(".price-per-unit").nextSibling);
      }
      if (price < originalPrice) {
        badgeEl.textContent = `-${Math.round((1 - price / originalPrice) * 100)}%`;
        textMutedEl?.classList.remove("d-none");
      } else {
        badgeEl.textContent = '';
        textMutedEl?.classList.add("d-none");
      }
    });

    subtotalDisplay.textContent = `$${subtotal.toFixed(2)}`;
    discountDisplay.textContent = `- $${totalDiscount.toFixed(2)}`;
    totalDisplay.textContent = `$${subtotal.toFixed(2)}`;
  };

  productCards.forEach(card => {
    card.querySelector(".apply-coupon-btn").addEventListener("click", (e) => {
      e.preventDefault();
      const input = card.querySelector(".product-coupon");
      const code = input.value.trim();
      if (!code) {
        toastBody.textContent = "Ingrese un código válido";
        toastEl.classList.remove("bg-success");
        toastEl.classList.add("bg-danger");
        toast.show();
        return;
      }

      const pid = card.dataset.productId;

      fetch(`/portal/cart/apply_discount_code`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ product_id: pid, code })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          cartData[pid].price = parseFloat(data.new_price);
          card.dataset.price = parseFloat(data.new_price);
          updateTotals();

          toastBody.textContent = `✅ Cupón aplicado: -${data.discount}% en ${data.product_name}`;
          toastEl.classList.remove("bg-danger");
          toastEl.classList.add("bg-success");
          toast.show();
        } else {
          toastBody.textContent = `❌ ${data.error}`;
          toastEl.classList.remove("bg-success");
          toastEl.classList.add("bg-danger");
          toast.show();
        }
      })
      .catch(err => console.error(err));
    });
  });
});
</script>
