<div class="container-fluid bg-light min-vh-100 py-5">
  <div class="container my-5">
    <h2 class="mb-4 text-center">Finalizar compra</h2>

    <div class="row g-4">
      <!-- Columna izquierda: listado de productos -->
      <div class="col-lg-8 col-md-7">
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Productos en tu carrito</h5>

          <% @cart_items.each do |item| %>
            <% product = item[:product] %>
            <% quantity = item[:quantity] %>
            <% discounted_price = product.discount.present? && product.discount > 0 ? (product.price - (product.price * product.discount / 100.0)) : product.price %>

            <div class="d-flex align-items-center mb-3 border-bottom pb-2 product-card" 
                 data-product-id="<%= product.id %>" 
                 data-price="<%= discounted_price %>" 
                 data-original-price="<%= product.price %>">
              
              <% if product.product_images.any? %>
                <%= image_tag product.product_images.first.image_url, class: "img-thumbnail me-3", style: "width: 120px; height: 120px;" %>
              <% else %>
                <%= image_tag "placeholder.png", class: "img-thumbnail me-3", style: "width: 120px; height: 120px;" %>
              <% end %>

              <div class="flex-grow-1 d-flex justify-content-between align-items-center">
                <div>
                  <strong class="fs-5"><%= product.name %></strong><br>

                  <% if product.discount.present? && product.discount > 0 %>
                    <div>
                      <i>Precio por unidad:</i>
                      <span class="text-muted text-decoration-line-through">$<%= '%.2f' % product.price %></span>
                      <span class="badge bg-danger ms-2">-<%= product.discount %>%</span><br>
                      <span class="text-success fw-bold fs-5">$<%= '%.2f' % discounted_price %></span>
                    </div>
                  <% else %>
                    <i>Precio por unidad:</i>
                    <span class="text-success fw-bold fs-5">$<%= '%.2f' % product.price %></span>
                  <% end %>

                  <div class="mt-2">
                    <strong>Subtotal:</strong>
                    <span class="text-success subtotal">$<%= '%.2f' % (discounted_price * quantity) %></span>
                  </div>
                </div>

               
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Columna derecha -->
      <div class="col-lg-4 col-md-5">
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">M√©todo de env√≠o</h5>
          <div class="p-2 border rounded text-center mb-2">
            <input type="radio" name="shipping" id="pickup" value="pickup" hidden checked>
            <label for="pickup" class="mb-0 fw-medium cursor-pointer">Recoger en tienda</label>
          </div>
          <p class="text-muted mt-2">El pago se realizar√° al momento de recoger el producto.</p>
          <div class="mb-3">
            <select class="form-select">
              <option value="">Selecciona tienda</option>
              <option value="san_salvador">San Salvador</option>
              <option value="santa_ana">Santa Ana</option>
            </select>
          </div>
        </div>

        <!-- Resumen de compra -->
        <div class="card p-4 shadow-sm mb-4">
          <h5 class="mb-3">Resumen de compra</h5>

          <div class="d-flex justify-content-between mb-1">
            <span>Subtotal:</span>
            <span id="subtotal-amount">$<%= '%.2f' % @subtotal %></span>
          </div>

          <div class="d-flex justify-content-between text-danger mb-1">
            <span>Descuentos aplicados:</span>
            <span id="discount-amount">- $<%= '%.2f' % (@cart_items.sum { |item| item[:product].price * item[:quantity] } - @subtotal) %></span>
          </div>

          <hr>

          <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
            <span>Total a pagar:</span>
            <span id="total-amount" class="text-success">$<%= '%.2f' % @total %></span>
          </div>

          <%= form_with url: portal_create_purchase_portal_carts_path, method: :post, local: false, id: "checkout-form" do |f| %>
            <div class="mt-4 text-center">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-circle"></i> Confirmar compra
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üîπ AJAX + JS din√°mico -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const productCards = document.querySelectorAll(".product-card");
  const subtotalDisplay = document.getElementById("subtotal-amount");
  const discountDisplay = document.getElementById("discount-amount");
  const totalDisplay = document.getElementById("total-amount");

  const cartData = {};

  productCards.forEach(card => {
    const productId = card.dataset.productId;
    const price = parseFloat(card.dataset.price);
    const originalPrice = parseFloat(card.dataset.originalPrice);
    const quantityEl = card.querySelector(".quantity");

    // Inicializar cartData
    cartData[productId] = parseInt(quantityEl.textContent);

    const updateTotals = () => {
      let subtotal = 0;
      let totalDiscount = 0;

      productCards.forEach(c => {
        const pid = c.dataset.productId;
        const qty = cartData[pid];
        const p = parseFloat(c.dataset.price);
        const op = parseFloat(c.dataset.originalPrice);

        subtotal += p * qty;
        totalDiscount += (op - p) * qty;

        c.querySelector(".subtotal").textContent = `$${(p * qty).toFixed(2)}`;
      });

      subtotalDisplay.textContent = `$${subtotal.toFixed(2)}`;
      discountDisplay.textContent = `- $${totalDiscount.toFixed(2)}`;
      totalDisplay.textContent = `$${subtotal.toFixed(2)}`;
    };

    card.querySelector(".btn-increase").addEventListener("click", () => {
      cartData[productId]++;
      quantityEl.textContent = cartData[productId];
      updateTotals();
      sendQuantityUpdate(productId, cartData[productId]);
    });

    card.querySelector(".btn-decrease").addEventListener("click", () => {
      if (cartData[productId] > 1) {
        cartData[productId]--;
        quantityEl.textContent = cartData[productId];
        updateTotals();
        sendQuantityUpdate(productId, cartData[productId]);
      }
    });

    const sendQuantityUpdate = (productId, quantity) => {
      
      fetch("<%= update_quantity_portal_carts_path %>", {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ product_id: productId, quantity: quantity })
    });

    };
  });
});
</script>

